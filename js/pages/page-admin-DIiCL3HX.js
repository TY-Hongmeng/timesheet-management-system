import{r as e,j as t,B as s,c as m,d as n,P as a,X as r,e as i,T as o,f as l,G as c,S as u,h,i as g,k as d,U as N,l as p}from"../libs/lib-react-CmVvENop.js";import{u as b,a as x,D as y,c as f,S as v,v as w,s as E,K as k,P as _,b as D,d as j,C as M}from"../libs/lib-dnd-kit-NakZffAn.js";import{u as V,L as U}from"../vendor-BPcnth7H.js";import{c as C}from"../libs/lib-supabase-CwH9oqoL.js";import{t as S}from"../libs/lib-toast-BLtamXt4.js";const R=C("https://agesdprmugyybtqrvqks.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZXNkcHJtdWd5eWJ0cXJ2cWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDY0OTIsImV4cCI6MjA3MDcyMjQ5Mn0.bfo_xb818yMd7-u6cJhDoJrqmDwcGY1nBDJIesFSfWk",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},global:{headers:{"X-Client-Info":"supabase-js-web-mobile-safari-optimized"},fetch:async(e,t)=>{try{const s=new AbortController,m=setTimeout(()=>s.abort(),1e4),n=await fetch(e,{...t,signal:s.signal});return clearTimeout(m),n}catch(s){throw s}}},db:{schema:"public"},realtime:{params:{eventsPerSecond:3}}});const I={USER_READ:"user:read",USER_MANAGE:"user:manage",USER_CREATE:"user:create",USER_DELETE:"user:delete",COMPANY_READ:"company:read",COMPANY_MANAGE:"company:manage",COMPANY_CREATE:"company:create",COMPANY_DELETE:"company:delete",PROCESS_READ:"process:read",PROCESS_MANAGE:"process:manage",PROCESS_CREATE:"process:create",PROCESS_DELETE:"process:delete",ROLE_MANAGE:"role:manage",SYSTEM_CONFIG:"system:config",TIME_RECORD:"time_record",REPORTS:"reports",HISTORY:"history",PROCESS_MANAGEMENT:"process_management",USER_MANAGEMENT:"user_management",COMPANY_MANAGEMENT:"company_management",SUPERVISOR_REVIEW:"supervisor_review",MANAGER_REVIEW:"manager_review",PERMISSION_MANAGEMENT:"permission_management"},q="超级管理员",O=[{id:"time_record",name:"记录工时",description:"记录和管理工作时间",icon:"Clock",path:"/timesheet-record",permission:I.TIME_RECORD,color:"from-green-400 to-green-600"},{id:"reports",name:"查看报表",description:"查看工时统计和分析报表",icon:"BarChart3",path:"/reports",permission:I.REPORTS,color:"from-blue-400 to-blue-600"},{id:"history",name:"历史记录",description:"查看个人工时历史记录",icon:"Activity",path:"/history",permission:I.HISTORY,color:"from-cyan-400 to-cyan-600"},{id:"process_management",name:"工序管理",description:"管理生产工序和流程",icon:"Settings",path:"/process-management",permission:I.PROCESS_MANAGEMENT,color:"from-purple-400 to-purple-600"},{id:"user_management",name:"用户管理",description:"管理系统用户和权限",icon:"Users",path:"/user-management",permission:I.USER_MANAGEMENT,color:"from-orange-400 to-orange-600"},{id:"company_management",name:"公司管理",description:"管理公司信息和部门",icon:"Building2",path:"/company-management",permission:I.COMPANY_MANAGEMENT,color:"from-teal-400 to-teal-600"},{id:"supervisor_review",name:"班长审核",description:"班长审核工时记录",icon:"CheckCircle",path:"/supervisor-approval",permission:I.SUPERVISOR_REVIEW,color:"from-indigo-400 to-indigo-600"},{id:"section_chief_review",name:"段长审核",description:"段长审核工时记录",icon:"Shield",path:"/section-chief-approval",permission:I.MANAGER_REVIEW,color:"from-pink-400 to-pink-600"},{id:"permission_management",name:"权限管理",description:"管理用户角色和权限",icon:"Key",path:"/role-permissions",permission:I.PERMISSION_MANAGEMENT,color:"from-red-400 to-red-600"}];async function P(e,t){try{return(await L(e)).includes(t)}catch(s){return!1}}let A=null;const T=6e5;async function L(e){try{if(A&&A.userId===e&&Date.now()-A.timestamp<T)return A.permissions;const{data:t,error:s}=await async function(e){try{return await async function(e,t=3,s=1e3){let m;for(let a=1;a<=t;a++)try{return await e()}catch(n){if(m=n,a===t)break;const e=s*Math.pow(2,a-1);await new Promise(t=>setTimeout(t,e))}throw m}(e,2,500)}catch(t){return{data:null,error:{message:"网络连接异常，请检查网络设置或稍后重试",code:"NETWORK_ERROR",details:t}}}}(async()=>await R.from("users").select("\n          id,\n          role_id,\n          user_roles (\n            id,\n            name,\n            permissions\n          )\n        ").eq("id",e).single());if(s||!t)return[];let m=[];return t.user_roles&&J(t.user_roles.name)?m=W():t.user_roles&&t.user_roles.permissions&&(m=t.user_roles.permissions),A={permissions:m,timestamp:Date.now(),userId:e},m}catch(t){return[]}}function G(e){return O.filter(t=>e.includes(t.permission))}function J(e){return"object"==typeof e&&null!==e?"超级管理员"===e.name:"超级管理员"===e}function z(){return O}const Y=(e,t)=>{if(!e)return!1;if(J(e.role||e.user_roles))return!0;const s=e.role||e.user_roles;return!(!s||!s.permissions)&&s.permissions.includes(t)},W=()=>Object.values(I),B=e.createContext(void 0);function F({children:s}){const[m,n]=e.useState(null),[a,r]=e.useState(!0);e.useEffect(()=>{(async()=>{try{const t=localStorage.getItem("auth_user"),s=localStorage.getItem("last_login_time");if(t&&s){const m=JSON.parse(t),a=parseInt(s),i=Date.now();if(i-a>864e5)return localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time"),n(null),void r(!1);if(!navigator.onLine)return n(m),void r(!1);try{const{data:e,error:t}=await Promise.race([R.from("users").select("\n                  *,\n                  company:companies(*),\n                  role:user_roles(*)\n                ").eq("id",m.id).eq("is_active",!0).single(),new Promise((e,t)=>setTimeout(()=>t(new Error("验证超时")),8e3))]);if(e&&!t){const t=await L(e.id),s={id:e.id,phone:e.phone,name:e.name,id_card:e.id_card,company:e.company,role:e.role,department_id:e.department_id,is_active:e.is_active,permissions:t};n(s),localStorage.setItem("auth_user",JSON.stringify(s)),localStorage.setItem("last_login_time",i.toString())}else localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time"),n(null)}catch(e){n(m)}}else n(null)}catch(t){localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time"),n(null)}finally{r(!1)}})();const e=setInterval(()=>{const e=localStorage.getItem("last_login_time");if(e){const t=parseInt(e);Date.now()-t>864e5&&(localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time"),n(null),window.location.href="/login")}},6e4),{data:{subscription:t}}=R.auth.onAuthStateChange(async(e,t)=>{"SIGNED_OUT"===e&&(n(null),localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time"))});return()=>{t.unsubscribe(),clearInterval(e)}},[]);const i=async(e,t,s=0)=>{var m,a,r,o,l,c,u,h;try{if(!navigator.onLine)return{success:!1,error:"网络连接已断开，请检查网络后重试"};const{data:s,error:m}=await Promise.race([R.from("users").select("\n            *,\n            company:companies(*),\n            role:user_roles(*)\n          ").eq("phone",e).eq("is_active",!0).single(),new Promise((e,t)=>setTimeout(()=>t(new Error("请求超时")),1e4))]);if(m){if("PGRST116"===m.code)return{success:!1,error:"用户不存在或已被禁用"};throw m}if(!s)return{success:!1,error:"用户不存在或已被禁用"};if(s.password_hash!==t)return{success:!1,error:"密码错误"};let a=[];s.role&&"超级管理员"===s.role.name?a=Object.values(I):setTimeout(async()=>{try{const e=await L(s.id),t=JSON.parse(localStorage.getItem("auth_user")||"{}");t.id===s.id&&(t.permissions=e,localStorage.setItem("auth_user",JSON.stringify(t)),n(t))}catch(e){}},100);const r={id:s.id,phone:s.phone,name:s.name,id_card:s.id_card,company:s.company,role:s.role,department_id:s.department_id,is_active:s.is_active,permissions:a};return n(r),localStorage.setItem("auth_user",JSON.stringify(r)),localStorage.setItem("last_login_time",Date.now().toString()),{success:!0}}catch(g){const n=(null==(m=g.message)?void 0:m.includes("fetch"))||(null==(a=g.message)?void 0:a.includes("network"))||(null==(r=g.message)?void 0:r.includes("CONNECTION_CLOSED"))||(null==(o=g.message)?void 0:o.includes("ERR_NETWORK_CHANGED"))||(null==(l=g.message)?void 0:l.includes("ERR_ABORTED"))||(null==(c=g.message)?void 0:c.includes("ERR_CONNECTION_CLOSED"))||(null==(u=g.message)?void 0:u.includes("请求超时"))||(null==(h=g.message)?void 0:h.includes("Failed to fetch"))||"NETWORK_ERROR"===g.code||"TypeError"===g.name||!navigator.onLine;return s<5&&n?(await new Promise(e=>setTimeout(e,1e3*Math.pow(2,s))),i(e,t,s+1)):n?{success:!1,error:"网络连接不稳定，已重试".concat(s,"次，请检查网络后重试")}:{success:!1,error:g.message||"登录失败，请稍后重试"}}},o={user:m,loading:a,login:i,register:async e=>{try{const{data:t,error:s}=await R.from("users").select("id").eq("id_card",e.id_card).maybeSingle();if(s&&"PGRST116"!==s.code)return{success:!1,error:"系统错误，请稍后重试"};const{data:m,error:n}=await R.from("users").select("id").eq("phone",e.phone).maybeSingle();if(n&&"PGRST116"!==n.code)return{success:!1,error:"系统错误，请稍后重试"};if(t||m){if(t)return{success:!1,error:"该身份证号已被注册"};if(m)return{success:!1,error:"该手机号已被注册"}}const a=crypto.randomUUID(),{error:r}=await R.from("users").insert({id:a,phone:e.phone,id_card:e.id_card,name:e.name,company_id:e.company_id,role_id:e.role_id,password_hash:e.password,production_line:e.production_line,is_active:!1});if(r)return{success:!1,error:"用户信息创建失败"};const{data:i}=await R.from("users").select("\n          *,\n          company:companies(*),\n          role:user_roles(*)\n        ").eq("id",a).single();return{success:!0}}catch(t){return{success:!1,error:t.message||"注册失败，请重试"}}},logout:async()=>{try{n(null),localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time")}catch(e){n(null),localStorage.removeItem("auth_user"),localStorage.removeItem("last_login_time")}},resetPassword:async(e,t)=>{var s;try{const{data:s,error:m}=await Promise.race([R.from("users").select("id, phone, name").eq("id_card",e).eq("is_active",!0).single(),new Promise((e,t)=>setTimeout(()=>t(new Error("查询超时")),8e3))]);if(m)return"PGRST116"===m.code?{success:!1,error:"未找到该身份证号对应的用户"}:{success:!1,error:"查询用户失败，请重试"};if(!s)return{success:!1,error:"未找到该身份证号对应的用户"};if(!t)return{success:!0,user:{id:s.id,phone:s.phone,name:s.name}};const{error:n}=await Promise.race([R.from("users").update({password_hash:t}).eq("id",s.id),new Promise((e,t)=>setTimeout(()=>t(new Error("更新超时")),8e3))]);return n?{success:!1,error:"密码重置失败，请重试"}:{success:!0}}catch(m){return(null==(s=m.message)?void 0:s.includes("超时"))?{success:!1,error:"网络超时，请检查网络连接后重试"}:{success:!1,error:m.message||"密码重置失败"}}},refreshUser:async()=>{if(null==m?void 0:m.id)try{const{data:e,error:t}=await R.from("users").select("\n          *,\n          company:companies(*),\n          role:user_roles(*)\n        ").eq("id",m.id).eq("is_active",!0).single();if(e&&!t){const t=await L(e.id),s={id:e.id,phone:e.phone,name:e.name,id_card:e.id_card,company:e.company,role:e.role,department_id:e.department_id,is_active:e.is_active,permissions:t};n(s),localStorage.setItem("auth_user",JSON.stringify(s))}}catch(e){}},isAuthenticated:()=>!!(m&&m.id&&m.is_active)};return t.jsxDEV(B.Provider,{value:o,children:s},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/contexts/AuthContext.tsx",lineNumber:498,columnNumber:10},this)}function X(){const t=e.useContext(B);if(void 0===t)throw new Error("useAuth must be used within an AuthProvider");return t}function K({company:e,index:s,onEdit:m,onDelete:n}){const{attributes:a,listeners:r,setNodeRef:i,transform:o,transition:h,isDragging:g}=j({id:e.id}),d={transform:M.Transform.toString(o),transition:h,opacity:g?.5:1};return t.jsxDEV("div",{ref:i,style:d,className:"px-6 py-4 hover:bg-green-900/10 transition-colors ".concat(g?"bg-gray-800/70 shadow-lg":""),children:t.jsxDEV("div",{className:"grid grid-cols-12 gap-4 items-center",children:[t.jsxDEV("div",{className:"col-span-1 flex items-center gap-2",children:[t.jsxDEV("div",{...a,...r,className:"cursor-grab active:cursor-grabbing text-green-400 hover:text-green-300 p-1",title:"拖拽排序",children:t.jsxDEV(c,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:69,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:63,columnNumber:11},this),t.jsxDEV("span",{className:"text-green-400 font-bold font-mono text-lg",children:s+1},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:71,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:62,columnNumber:9},this),t.jsxDEV("div",{className:"col-span-6",children:t.jsxDEV("h3",{className:"text-green-400 font-bold font-mono text-lg",children:e.name},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:76,columnNumber:11},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:75,columnNumber:9},this),t.jsxDEV("div",{className:"col-span-3",children:t.jsxDEV("span",{className:"text-green-600 font-mono text-sm",children:new Date(e.created_at).toLocaleString()},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:81,columnNumber:11},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:80,columnNumber:9},this),t.jsxDEV("div",{className:"col-span-2",children:t.jsxDEV("div",{className:"flex gap-2",children:[t.jsxDEV("button",{onClick:()=>m(e),className:"text-green-400 hover:text-green-300 transition-colors p-1",title:"编辑",children:t.jsxDEV(u,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:92,columnNumber:15},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:87,columnNumber:13},this),t.jsxDEV("button",{onClick:()=>n(e),className:"text-red-400 hover:text-red-300 transition-colors p-1",title:"删除",children:t.jsxDEV(l,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:99,columnNumber:15},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:94,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:86,columnNumber:11},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:85,columnNumber:9},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:61,columnNumber:7},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:54,columnNumber:5},this)}const H=Object.freeze(Object.defineProperty({__proto__:null,default:function(){const[c,u]=e.useState([]),[h,g]=e.useState(!0),[d,N]=e.useState(!1),[p,j]=e.useState(null),[M,C]=e.useState({name:""}),[S,I]=e.useState(!1),[q,O]=e.useState(!1),[P,A]=e.useState(null),[T,L]=e.useState(""),[G,J]=e.useState(""),{user:z,loading:Y}=X(),W=V(),B=b(x(_),x(k,{coordinateGetter:E}));if(e.useEffect(()=>{Y||z||W("/login")},[z,Y,W]),Y)return t.jsxDEV("div",{className:"min-h-screen bg-black flex items-center justify-center",children:t.jsxDEV("div",{className:"text-center",children:[t.jsxDEV("div",{className:"text-green-400 text-2xl font-mono mb-4",children:"加载中..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:147,columnNumber:11},this),t.jsxDEV("div",{className:"text-green-600 font-mono",children:"正在验证用户身份"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:148,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:146,columnNumber:9},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:145,columnNumber:7},this);e.useEffect(()=>{F()},[]);const F=async()=>{g(!0),L("");try{if(!z)return void L("用户未登录，请重新登录");const{data:e,error:t}=await R.from("companies").select("*").order("order_index",{ascending:!0});if(t)throw t;u(e||[])}catch(e){L("获取公司列表失败，请重试")}finally{g(!1)}},H=e=>{j(e),C({name:e.name}),N(!0)},Z=e=>{A(e),O(!0)},Q=()=>{C({name:""}),j(null),N(!1),L("")};return h?t.jsxDEV("div",{className:"min-h-screen bg-black flex items-center justify-center",children:t.jsxDEV("div",{className:"text-green-400 text-xl animate-pulse font-mono",children:"加载中..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:340,columnNumber:9},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:339,columnNumber:7},this):t.jsxDEV("div",{className:"min-h-screen bg-black text-green-300 p-6",children:t.jsxDEV("div",{className:"max-w-7xl mx-auto",children:[t.jsxDEV("div",{className:"mb-8",children:[t.jsxDEV("div",{className:"flex justify-between items-center mb-4",children:[t.jsxDEV("div",{className:"flex items-center",children:[t.jsxDEV(s,{className:"w-8 h-8 text-green-400 mr-3"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:355,columnNumber:15},this),t.jsxDEV("h1",{className:"text-4xl font-bold text-green-400 font-mono",children:"公司管理"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:356,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:354,columnNumber:13},this),t.jsxDEV(U,{to:"/dashboard",className:"flex items-center gap-2 px-3 py-2 sm:px-4 sm:py-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-green-300 hover:text-green-200 rounded-lg font-mono transition-all duration-200 shadow-md hover:shadow-lg border border-gray-600 hover:border-green-500/50",children:[t.jsxDEV(m,{className:"w-5 h-5"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:362,columnNumber:15},this),t.jsxDEV("span",{className:"hidden sm:inline",children:"返回控制台"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:363,columnNumber:15},this),t.jsxDEV("span",{className:"sm:hidden",children:"返回"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:364,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:358,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:353,columnNumber:11},this),t.jsxDEV("div",{className:"h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:367,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:352,columnNumber:9},this),t.jsxDEV("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[t.jsxDEV("div",{className:"flex-1",children:t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(n,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-green-400/60"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:374,columnNumber:15},this),t.jsxDEV("input",{type:"text",placeholder:"搜索公司名称...",className:"w-full bg-black border border-green-400/30 rounded px-10 py-2 text-green-400 placeholder-green-400/60 focus:outline-none focus:border-green-400"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:375,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:373,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:372,columnNumber:11},this),t.jsxDEV("button",{onClick:()=>N(!0),className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 text-black font-bold rounded transition-colors font-mono",children:[t.jsxDEV(a,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:386,columnNumber:13},this),"新增公司"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:382,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:371,columnNumber:9},this),T&&t.jsxDEV("div",{className:"mb-6 p-4 bg-red-900/50 border border-red-400 rounded text-red-300",children:T},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:392,columnNumber:11},this),d&&t.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:t.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[t.jsxDEV("div",{className:"flex justify-between items-center mb-6",children:[t.jsxDEV("h2",{className:"text-2xl font-bold text-green-400 font-mono",children:p?"编辑公司":"新增公司"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:404,columnNumber:17},this),t.jsxDEV("button",{onClick:Q,className:"text-green-400 hover:text-green-300",children:t.jsxDEV(r,{className:"w-6 h-6"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:411,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:407,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:403,columnNumber:15},this),t.jsxDEV("form",{onSubmit:async e=>{e.preventDefault(),I(!0),L("");let t="";try{if(p){const{data:e,error:s}=await R.from("companies").update({name:M.name,updated_at:(new Date).toISOString()}).eq("id",p.id).select();if(s)throw new Error(s.message);if(!e||0===e.length)throw new Error("更新失败：权限不足或记录不存在");const m=e[0];u(e=>e.map(e=>e.id===m.id?m:e)),t='公司 "'.concat(m.name,'" 更新成功')}else{const{data:e,error:s}=await R.from("companies").insert([M]).select();if(s)throw new Error(s.message);const m=e[0];u(e=>[...e,m]),t='公司 "'.concat(m.name,'" 创建成功')}L(""),J(t),await F(),Q()}catch(s){L(s.message||"保存失败")}finally{I(!1)}},className:"space-y-4",children:[t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"公司名称 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:417,columnNumber:19},this),t.jsxDEV("input",{type:"text",name:"name",value:M.name,onChange:e=>{C({...M,[e.target.name]:e.target.value})},required:!0,className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入公司名称"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:420,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:416,columnNumber:17},this),t.jsxDEV("div",{className:"flex gap-3 pt-4",children:[t.jsxDEV("button",{type:"submit",disabled:S,className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-green-800 text-black font-bold rounded transition-colors font-mono",children:[t.jsxDEV(i,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:439,columnNumber:21},this),S?"保存中...":"保存"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:434,columnNumber:19},this),t.jsxDEV("button",{type:"button",onClick:Q,className:"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:442,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:433,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:415,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:402,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:401,columnNumber:11},this),q&&P&&t.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:t.jsxDEV("div",{className:"bg-gray-900 border border-red-400 rounded-lg p-6 w-full max-w-md",children:[t.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[t.jsxDEV(o,{className:"text-red-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:460,columnNumber:17},this),t.jsxDEV("h2",{className:"text-xl font-bold text-red-400 font-mono",children:"确认删除"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:461,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:459,columnNumber:15},this),t.jsxDEV("div",{className:"mb-6",children:[t.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:"您确定要删除以下公司吗？"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:467,columnNumber:17},this),t.jsxDEV("div",{className:"bg-black border border-green-400 rounded p-3 mb-3",children:t.jsxDEV("p",{className:"text-green-400 font-mono font-bold",children:P.name},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:471,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:470,columnNumber:17},this),t.jsxDEV("p",{className:"text-red-300 text-sm font-mono",children:"⚠️ 此操作不可恢复，请谨慎操作！"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:475,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:466,columnNumber:15},this),t.jsxDEV("div",{className:"flex gap-3",children:[t.jsxDEV("button",{onClick:async()=>{if(P)try{const{error:e}=await R.from("companies").delete().eq("id",P.id);if(e)throw e;await F(),O(!1),A(null)}catch(e){L(e.message||"删除失败")}},className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded transition-colors font-mono",children:[t.jsxDEV(l,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:485,columnNumber:19},this),"确认删除"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:481,columnNumber:17},this),t.jsxDEV("button",{onClick:()=>{O(!1),A(null)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:488,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:480,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:458,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:457,columnNumber:11},this),t.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg overflow-hidden",children:[t.jsxDEV("div",{className:"bg-green-900/30 border-b border-green-400 px-6 py-4",children:t.jsxDEV("div",{className:"grid grid-cols-12 gap-4 items-center",children:[t.jsxDEV("div",{className:"col-span-1",children:t.jsxDEV("span",{className:"text-green-400 font-bold font-mono text-sm",children:"排序"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:505,columnNumber:17},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:504,columnNumber:15},this),t.jsxDEV("div",{className:"col-span-6",children:t.jsxDEV("span",{className:"text-green-400 font-bold font-mono text-sm",children:"公司名称"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:508,columnNumber:17},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:507,columnNumber:15},this),t.jsxDEV("div",{className:"col-span-3",children:t.jsxDEV("span",{className:"text-green-400 font-bold font-mono text-sm",children:"创建时间"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:511,columnNumber:17},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:510,columnNumber:15},this),t.jsxDEV("div",{className:"col-span-2",children:t.jsxDEV("span",{className:"text-green-400 font-bold font-mono text-sm",children:"操作"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:514,columnNumber:17},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:513,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:503,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:502,columnNumber:11},this),t.jsxDEV(y,{sensors:B,collisionDetection:f,onDragEnd:async e=>{const{active:t,over:s}=e;if(t.id!==(null==s?void 0:s.id)){const e=c.findIndex(e=>e.id===t.id),n=c.findIndex(e=>e.id===(null==s?void 0:s.id)),a=D(c,e,n);u(a);try{const e=a.map((e,t)=>({id:e.id,order_index:t+1}));for(const t of e)await R.from("companies").update({order_index:t.order_index}).eq("id",t.id)}catch(m){await F()}}},children:t.jsxDEV(v,{items:c.map(e=>e.id),strategy:w,children:t.jsxDEV("div",{className:"divide-y divide-green-800",children:c.map((e,s)=>t.jsxDEV(K,{company:e,index:s,onEdit:H,onDelete:Z},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:531,columnNumber:19},this))},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:529,columnNumber:15},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:525,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:520,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:500,columnNumber:9},this),0===c.length&&t.jsxDEV("div",{className:"text-center py-12",children:[t.jsxDEV(s,{className:"w-16 h-16 text-green-600 mx-auto mb-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:546,columnNumber:13},this),t.jsxDEV("p",{className:"text-green-400 text-lg font-mono",children:"暂无公司数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:547,columnNumber:13},this),t.jsxDEV("p",{className:"text-green-600 text-sm font-mono mt-2",children:"点击上方按钮添加第一家公司"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:550,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:545,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:349,columnNumber:7},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/CompanyManagement.tsx",lineNumber:348,columnNumber:5},this)}},Symbol.toStringTag,{value:"Module"})),Z=Object.freeze(Object.defineProperty({__proto__:null,default:function(){var c,b,x,y,f,v,w,E,k,_,D,j,M,C,I,q,O,P,A,T,L,G;const[z,Y]=e.useState([]),[W,B]=e.useState([]),[F,K]=e.useState([]),[H,Z]=e.useState([]),[Q,$]=e.useState(!1),[ee,te]=e.useState(!0),[se,me]=e.useState(""),[ne,ae]=e.useState(!1),[re,ie]=e.useState(null),[oe,le]=e.useState({phone:"",id_card:"",name:"",company_id:"",role_id:"",production_line:"",is_active:!1}),[ce,ue]=e.useState(!1),[he,ge]=e.useState(!1),[de,Ne]=e.useState(null),[pe,be]=e.useState(!1),[xe,ye]=e.useState({user:null,oldRole:null,newRole:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),[fe,ve]=e.useState(""),[we,Ee]=e.useState(!1),[ke,_e]=e.useState({user:null,oldProductionLine:"",newProductionLine:"",role:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),[De,je]=e.useState(""),[Me,Ve]=e.useState(""),{user:Ue,loading:Ce}=X(),Se=V();if(e.useEffect(()=>{Ce||Ue||Se("/login")},[Ue,Ce,Se]),Ce)return t.jsxDEV("div",{className:"min-h-screen bg-black flex items-center justify-center",children:t.jsxDEV("div",{className:"text-center",children:[t.jsxDEV("div",{className:"text-green-400 text-2xl font-mono mb-4",children:"加载中..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:101,columnNumber:11},this),t.jsxDEV("div",{className:"text-green-600 font-mono",children:"正在验证用户身份"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:102,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:100,columnNumber:9},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:99,columnNumber:7},this);e.useEffect(()=>{Re()},[]);const Re=async()=>{var e,t,s;try{if(!Ue)return void S.error("用户信息不存在");let m=R.from("users").select("\n          *,\n          company:companies(name),\n          role:user_roles(name, permissions)\n        ");if(!J(Ue.role)){if(!(null==(e=Ue.company)?void 0:e.id))return void S.error("用户没有关联的公司，请联系管理员");m=m.eq("company_id",Ue.company.id)}const{data:n,error:a}=await m.order("created_at",{ascending:!1});if(a)throw a;let r=R.from("companies").select("*");J(Ue.role)||(r=r.eq("id",null==(t=Ue.company)?void 0:t.id));const{data:i,error:o}=await r.order("name");if(o)throw o;const{data:l,error:c}=await R.from("user_roles").select("*").order("name");if(c)throw c;Y(n||[]),B(i||[]),K(l||[]),!J(Ue.role)&&(null==(s=Ue.company)?void 0:s.id)&&le(e=>({...e,company_id:Ue.company.id}))}catch(m){Ve("获取数据失败")}finally{te(!1)}},[Ie,qe]=e.useState(""),Oe=async e=>{try{const{data:t,error:s}=await R.from("processes").select("production_line").eq("company_id",e).not("production_line","is",null);if(s)throw s;const m=[...new Set((null==t?void 0:t.map(e=>e.production_line).filter(Boolean))||[])];Z(m)}catch(t){Z([])}},Pe=()=>{var e;const t={phone:"",id_card:"",name:"",company_id:"",role_id:"",production_line:"",is_active:!1};!J(Ue.role)&&(null==(e=Ue.company)?void 0:e.id)&&(t.company_id=Ue.company.id),le(t),ie(null),ae(!1),$(!1),Z([]),Ve("")},Ae=e=>{const{name:t,value:s}=e.target;if(le({...oe,[t]:s}),"role_id"===t){const e=F.find(e=>e.id===s),t="班长"===(null==e?void 0:e.name)||"段长"===(null==e?void 0:e.name);$(t),t&&oe.company_id?Oe(oe.company_id):(Z([]),le(e=>({...e,production_line:""})))}"company_id"===t&&(Q&&s?Oe(s):Z([]),le(e=>({...e,production_line:""})))},Te=z.filter(e=>{var t;return e.name.toLowerCase().includes(se.toLowerCase())||e.phone.includes(se)||e.id_card.includes(se)||(null==(t=e.company)?void 0:t.name)&&e.company.name.toLowerCase().includes(se.toLowerCase())});return ee?t.jsxDEV("div",{className:"min-h-screen bg-black flex items-center justify-center",children:t.jsxDEV("div",{className:"text-green-400 text-xl animate-pulse font-mono",children:"加载中..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1276,columnNumber:9},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1275,columnNumber:7},this):t.jsxDEV("div",{className:"min-h-screen bg-black text-green-300 p-6",children:t.jsxDEV("div",{className:"max-w-7xl mx-auto",children:[t.jsxDEV("div",{className:"mb-8",children:[t.jsxDEV("div",{className:"flex justify-between items-center mb-4",children:[t.jsxDEV("div",{className:"flex items-center",children:[t.jsxDEV(h,{className:"w-8 h-8 text-green-400 mr-3"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1290,columnNumber:15},this),t.jsxDEV("h1",{className:"text-4xl font-bold text-green-400 font-mono",children:"用户管理"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1291,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1289,columnNumber:13},this),t.jsxDEV(U,{to:"/dashboard",className:"flex items-center gap-2 px-3 py-2 sm:px-4 sm:py-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-green-300 hover:text-green-200 rounded-lg font-mono transition-all duration-200 shadow-md hover:shadow-lg border border-gray-600 hover:border-green-500/50",children:[t.jsxDEV(m,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1297,columnNumber:15},this),t.jsxDEV("span",{className:"hidden sm:inline",children:"返回控制台"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1298,columnNumber:15},this),t.jsxDEV("span",{className:"sm:hidden",children:"返回"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1299,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1293,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1288,columnNumber:11},this),t.jsxDEV("div",{className:"h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1302,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1287,columnNumber:9},this),Me&&t.jsxDEV("div",{className:"mb-6 p-4 bg-red-900/50 border border-red-400 rounded text-red-300",children:Me},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1306,columnNumber:11},this),t.jsxDEV("div",{className:"mb-6 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center",children:[t.jsxDEV("div",{className:"relative flex-1 max-w-md",children:[t.jsxDEV(n,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1315,columnNumber:13},this),t.jsxDEV("input",{type:"text",value:se,onChange:e=>me(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-900 border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"搜索用户姓名、手机号、身份证号或公司..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1316,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1314,columnNumber:11},this),t.jsxDEV("button",{onClick:()=>{Pe(),ae(!0)},className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 text-black font-bold rounded transition-colors font-mono",children:[t.jsxDEV(a,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1333,columnNumber:13},this),"新增用户"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1326,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1312,columnNumber:9},this),ne&&t.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:t.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[t.jsxDEV("div",{className:"flex justify-between items-center mb-6",children:[t.jsxDEV("h2",{className:"text-2xl font-bold text-green-400 font-mono",children:re?"编辑用户":"新增用户"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1343,columnNumber:17},this),t.jsxDEV("button",{onClick:Pe,className:"text-green-400 hover:text-green-300",children:t.jsxDEV(r,{className:"w-6 h-6"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1350,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1346,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1342,columnNumber:15},this),t.jsxDEV("form",{onSubmit:async e=>{var t,s;e.preventDefault(),ue(!0),Ve("");try{if(!J(Ue.role)){if(oe.company_id!==(null==(t=Ue.company)?void 0:t.id))return S.error("您只能操作自己公司的用户"),void ue(!1);if(re&&re.company_id!==(null==(s=Ue.company)?void 0:s.id))return S.error("您只能编辑自己公司的用户"),void ue(!1)}if(re){const e=F.find(e=>e.id===re.role_id),t=F.find(e=>e.id===oe.role_id),s=re.production_line!==oe.production_line;if(("班长"===(null==e?void 0:e.name)||"段长"===(null==e?void 0:e.name))&&e.id!==(null==t?void 0:t.id)){let s=R.from("timesheet_records").select("id, user_id, status").in("status",["pending","待审核","submitted","已提交"]);"班长"===e.name?s=s.eq("supervisor_id",re.id):"段长"===e.name&&(s=s.eq("section_chief_id",re.id));const{data:m,error:n}=await s;if(n)throw new Error("检查待审核数据失败，请稍后重试");if(m&&m.length>0){const{data:s}=await R.from("timesheet_records").select("\n                id, user_id, status, work_date,\n                user:users!user_id(id, name, is_active)\n              ").in("id",m.map(e=>e.id)),n=(null==s?void 0:s.filter(e=>{const t=e.user,s=null==t?void 0:t.is_active,m=e.work_date&&new Date(e.work_date)<=new Date;return s&&m}))||[];if(n.length>0){const{data:s}=await R.from("users").select("id, name, phone").eq("company_id",re.company_id).eq("production_line",re.production_line).eq("role_id",re.role_id).eq("is_active",!0).neq("id",re.id);if(!s||0===s.length){const t=[...new Set(n.map(e=>{var t;return null==(t=e.user)?void 0:t.name}))].join("、"),s="无法修改".concat(e.name,"角色：还有").concat(n.length,"条待审核的工时记录需要处理，但该生产线没有其他激活的").concat(e.name,"可以接收这些数据。涉及员工：").concat(t,"。请先在该生产线添加其他").concat(e.name,"或手动处理这些待审核数据。");return S.error(s),void ue(!1)}const m=[...new Set(n.map(e=>{var t;return null==(t=e.user)?void 0:t.name}))];return ye({user:re,oldRole:e,newRole:t,pendingRecords:n,sameRoleUsers:s||[],userNames:m}),be(!0),void ue(!1)}}}if(("班长"===(null==e?void 0:e.name)||"段长"===(null==e?void 0:e.name))&&s){let t=R.from("timesheet_records").select("id, user_id, status");"班长"===e.name?t=t.eq("supervisor_id",re.id).in("status",["pending","待审核","submitted","已提交"]):"段长"===e.name&&(t=t.eq("section_chief_id",re.id).in("status",["approved"]));const{data:s,error:m}=await t;if(m)throw new Error("检查待审核数据失败，请稍后重试");if(s&&s.length>0){const{data:t}=await R.from("timesheet_records").select("\n                id, user_id, status, work_date,\n                user:users!user_id(id, name, is_active)\n              ").in("id",s.map(e=>e.id)),m=(null==t?void 0:t.filter(e=>{const t=e.user,s=null==t?void 0:t.is_active,m=e.work_date&&new Date(e.work_date)<=new Date;return s&&m}))||[];if(m.length>0){const{data:t,error:s}=await R.from("users").select("id, name, phone").eq("company_id",re.company_id).eq("production_line",re.production_line).eq("role_id",re.role_id).eq("is_active",!0).neq("id",re.id);if(!t||0===t.length){const t=[...new Set(m.map(e=>{var t;return null==(t=e.user)?void 0:t.name}))].join("、"),s="无法更换生产线：还有".concat(m.length,"条待审核的工时记录需要处理，但原生产线(").concat(re.production_line,")没有其他激活的").concat(e.name,"可以接收这些数据。涉及员工：").concat(t,"。请先在原生产线添加其他").concat(e.name,"或手动处理这些待审核数据。");return S.error(s),void ue(!1)}const n=[...new Set(m.map(e=>{var t;return null==(t=e.user)?void 0:t.name}))];return _e({user:re,oldProductionLine:re.production_line,newProductionLine:oe.production_line,role:e,pendingRecords:m,sameRoleUsers:t||[],userNames:n}),Ee(!0),void ue(!1)}}}const{data:m,error:n}=await R.from("users").update({phone:oe.phone,id_card:oe.id_card,name:oe.name,company_id:oe.company_id,role_id:oe.role_id,production_line:oe.production_line||null,is_active:oe.is_active,updated_at:(new Date).toISOString()}).eq("id",re.id).select("*");if(n)throw n;if(!m||0===m.length)throw new Error("更新失败：无法获取更新后的数据，请检查权限设置")}else{const{data:e}=await R.from("users").select("id").or("phone.eq.".concat(oe.phone,",id_card.eq.").concat(oe.id_card)).single();if(e)throw new Error("手机号或身份证号已存在");const t="123456",{data:s,error:m}=await R.from("users").insert([{phone:oe.phone,password_hash:t,id_card:oe.id_card,name:oe.name,company_id:oe.company_id,role_id:oe.role_id,production_line:oe.production_line||null,is_active:oe.is_active}]).select("*");if(m)throw m;if(!s||0===s.length)throw new Error("创建失败：无法获取创建后的数据，请检查权限设置")}await Re(),Pe()}catch(m){Ve(m.message||"保存失败")}finally{ue(!1)}},className:"space-y-4",children:[t.jsxDEV("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"姓名 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1357,columnNumber:21},this),t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(h,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1361,columnNumber:23},this),t.jsxDEV("input",{type:"text",name:"name",value:oe.name,onChange:Ae,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入姓名"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1362,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1360,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1356,columnNumber:19},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"手机号 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1375,columnNumber:21},this),t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1379,columnNumber:23},this),t.jsxDEV("input",{type:"tel",name:"phone",value:oe.phone,onChange:Ae,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入手机号",maxLength:11},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1380,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1378,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1374,columnNumber:19},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"身份证号 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1394,columnNumber:21},this),t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(d,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1398,columnNumber:23},this),t.jsxDEV("input",{type:"text",name:"id_card",value:oe.id_card,onChange:Ae,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入身份证号",maxLength:18},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1399,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1397,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1393,columnNumber:19},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"所属公司 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1415,columnNumber:21},this),t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(s,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1419,columnNumber:23},this),J(Ue.role)&&!re?t.jsxDEV("select",{name:"company_id",value:oe.company_id,onChange:Ae,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",children:[t.jsxDEV("option",{value:"",children:"请选择公司"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1428,columnNumber:27},this),W.map(e=>t.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1430,columnNumber:29},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1421,columnNumber:25},this):t.jsxDEV("div",{className:"w-full pl-10 pr-4 py-2 bg-gray-800 border border-green-400 rounded text-green-300 font-mono text-sm",children:[(null==(c=W.find(e=>e.id===oe.company_id))?void 0:c.name)||(null==(b=Ue.company)?void 0:b.name)||"当前公司",re&&t.jsxDEV("span",{className:"ml-2 text-yellow-400 text-xs",children:"(编辑时不可修改)"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1439,columnNumber:29},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1436,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1418,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1414,columnNumber:19},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"用户角色 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1447,columnNumber:21},this),t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(N,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1451,columnNumber:23},this),t.jsxDEV("select",{name:"role_id",value:oe.role_id,onChange:Ae,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",children:[t.jsxDEV("option",{value:"",children:"请选择角色"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1459,columnNumber:25},this),F.map(e=>t.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1461,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1452,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1450,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1446,columnNumber:19},this),Q&&t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"生产线 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1472,columnNumber:23},this),t.jsxDEV("select",{name:"production_line",value:oe.production_line||"",onChange:Ae,className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[t.jsxDEV("option",{value:"",children:"请选择生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1482,columnNumber:25},this),H.map(e=>t.jsxDEV("option",{value:e,children:e},e,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1484,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1475,columnNumber:23},this),0===H.length&&oe.company_id&&t.jsxDEV("div",{className:"mt-1 text-yellow-400 text-xs font-mono",children:"该公司暂无可用生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1490,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1471,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1355,columnNumber:17},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"用户状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1499,columnNumber:19},this),t.jsxDEV("div",{className:"relative",children:[t.jsxDEV(p,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1503,columnNumber:21},this),t.jsxDEV("select",{name:"is_active",value:oe.is_active.toString(),onChange:e=>le({...oe,is_active:"true"===e.target.value}),className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",children:[t.jsxDEV("option",{value:"true",children:"激活"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1510,columnNumber:23},this),t.jsxDEV("option",{value:"false",children:"禁用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1511,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1504,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1502,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1498,columnNumber:17},this),t.jsxDEV("div",{className:"flex gap-3 pt-4",children:[t.jsxDEV("button",{type:"submit",disabled:ce,className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-green-800 text-black font-bold rounded transition-colors font-mono",children:[t.jsxDEV(i,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1522,columnNumber:21},this),ce?"保存中...":"保存"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1517,columnNumber:19},this),t.jsxDEV("button",{type:"button",onClick:Pe,className:"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1525,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1516,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1354,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1341,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1340,columnNumber:11},this),t.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg overflow-hidden",children:t.jsxDEV("div",{className:"overflow-x-auto",children:t.jsxDEV("table",{className:"w-full",children:[t.jsxDEV("thead",{className:"bg-green-900/30",children:t.jsxDEV("tr",{children:[t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"姓名"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1544,columnNumber:19},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"手机号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1545,columnNumber:17},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"身份证号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1548,columnNumber:17},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"公司"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1551,columnNumber:17},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"角色"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1554,columnNumber:17},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1557,columnNumber:17},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1560,columnNumber:17},this),t.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"操作"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1563,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1543,columnNumber:17},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1542,columnNumber:15},this),t.jsxDEV("tbody",{className:"divide-y divide-green-800",children:Te.map(e=>{var s,m;return t.jsxDEV("tr",{className:"hover:bg-green-900/10",children:[t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("div",{className:"flex items-center",children:[t.jsxDEV(h,{className:"w-4 h-4 text-green-400 mr-2"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1573,columnNumber:25},this),t.jsxDEV("span",{className:"text-sm font-mono font-medium text-green-300",children:e.name},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1574,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1572,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1571,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:e.phone},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1580,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1579,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:e.id_card},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1585,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1584,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:(null==(s=e.company)?void 0:s.name)||"未分配"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1590,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1589,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:(null==(m=e.role)?void 0:m.name)||"未分配"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1595,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1594,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:e.production_line||"-"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1600,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1599,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:t.jsxDEV("button",{onClick:()=>(async e=>{var t;const s=!e.is_active;try{if(!J(Ue.role)&&e.company_id!==(null==(t=Ue.company)?void 0:t.id))return void S.error("您只能修改自己公司用户的状态");const{data:m,error:n}=await R.from("users").update({is_active:s,updated_at:(new Date).toISOString()}).eq("id",e.id).select("*");if(n)throw n;if(!m||0===m.length)throw new Error("状态更新失败：无法获取更新后的数据，请检查权限设置");S.success("用户状态更新成功"),await Re()}catch(m){Ve(m.message||"更新状态失败"),S.error("更新用户状态失败")}})(e),className:"inline-flex px-2 py-1 text-xs font-mono font-semibold rounded-full ".concat(e.is_active?"bg-green-900/50 text-green-300 border border-green-400":"bg-red-900/50 text-red-300 border border-red-400"),children:e.is_active?"激活":"禁用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1605,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1604,columnNumber:21},this),t.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap text-sm font-medium",children:t.jsxDEV("div",{className:"flex gap-2",children:[t.jsxDEV("button",{onClick:()=>(e=>{var t;if(!J(Ue.role)&&e.company_id!==(null==(t=Ue.company)?void 0:t.id))return void S.error("您只能编辑自己公司的用户");ie(e),le({phone:e.phone,id_card:e.id_card,name:e.name,company_id:e.company_id,role_id:e.role_id,production_line:e.production_line||"",is_active:e.is_active});const s=F.find(t=>t.id===e.role_id),m="班长"===(null==s?void 0:s.name)||"段长"===(null==s?void 0:s.name);$(m),m&&e.company_id&&Oe(e.company_id),ae(!0)})(e),className:"text-green-400 hover:text-green-300 transition-colors",title:"编辑",children:t.jsxDEV(u,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1623,columnNumber:27},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1618,columnNumber:25},this),t.jsxDEV("button",{onClick:()=>(async e=>{var t;try{if(!J(Ue.role)&&e.company_id!==(null==(t=Ue.company)?void 0:t.id))return void S.error("您只能删除自己公司的用户");const m=F.find(t=>t.id===e.role_id);if(m&&"超级管理员"===m.name)return void S.error("超级管理员角色不能被删除，这是系统保护机制");if(m&&("班长"===m.name||"段长"===m.name))try{let t=R.from("timesheet_records").select("id, user_id, status");"班长"===m.name?t=t.eq("supervisor_id",e.id):"段长"===m.name&&(t=t.eq("section_chief_id",e.id));const{data:s,error:n}=await t;s&&s.length>0&&s.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});let a=R.from("timesheet_records").select("id, user_id, status");if("班长"===m.name)a=a.in("status",["pending","待审核","submitted","已提交"]).eq("supervisor_id",e.id);else if("段长"===m.name){const{data:t,error:s}=await R.from("timesheet_records").select("id, user_id, status, section_chief_id, supervisor_id, work_date, created_at").eq("section_chief_id",e.id);t&&(t.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{}),t.forEach(e=>{})),a=a.eq("status","approved").eq("section_chief_id",e.id)}const{data:r,error:i}=await a;if("段长"===m.name&&r&&r.length>0&&r.forEach(e=>{}),i)return void S.error("检查待审核数据失败，请稍后重试");if(r&&r.length>0){const{data:t,error:s}=await R.from("timesheet_records").select("\n              id, user_id, status, work_date, created_at, updated_at,\n              user:users!user_id(id, name, is_active)\n            ").in("id",r.map(e=>e.id)),n=(null==t?void 0:t.filter(e=>{const t=e.user,s=null==t?void 0:t.is_active,m=e.work_date&&new Date(e.work_date)<=new Date;return s&&m}))||[];if(0!==n.length){const t=n,s=[...new Set(t.map(e=>e.user_id))],{data:a}=await R.from("users").select("name").in("id",s),r=a?a.map(e=>e.name):[],{data:i,error:o}=await R.from("users").select("id, name, phone").eq("company_id",e.company_id).eq("production_line",e.production_line).eq("role_id",e.role_id).eq("is_active",!0).neq("id",e.id);if(o)return void S.error("查找接收人失败，请稍后重试");if(!i||0===i.length){const e="无法删除".concat(m.name,"：还有").concat(t.length,"条待审核的工时记录需要处理，但该生产线没有其他激活的").concat(m.name,"可以接收这些数据。涉及员工：").concat(r.join("、"),"。请先在该生产线添加其他").concat(m.name,"或手动处理这些待审核数据。");return void S.error(e)}return Ne({...e,role:m,pendingRecords:t,sameRoleUsers:i,userNames:r}),void ge(!0)}r.filter(e=>!n.find(t=>t.id===e.id)).map(e=>e.id).length}}catch(s){return void S.error("检查待审核数据时出错，请稍后重试")}Ne({...e,role:m}),ge(!0)}catch(s){S.error("操作失败："+(s.message||"未知错误"))}})(e),className:"text-red-400 hover:text-red-300 transition-colors",title:"删除",children:t.jsxDEV(l,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1630,columnNumber:27},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1625,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1617,columnNumber:23},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1616,columnNumber:21},this)]},e.id,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1570,columnNumber:19},this)})},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1568,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1541,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1540,columnNumber:11},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1539,columnNumber:9},this),0===Te.length&&t.jsxDEV("div",{className:"text-center py-12",children:[t.jsxDEV(h,{className:"w-16 h-16 text-green-600 mx-auto mb-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1643,columnNumber:13},this),t.jsxDEV("p",{className:"text-green-400 text-lg font-mono",children:se?"未找到匹配的用户":"暂无用户数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1644,columnNumber:13},this),t.jsxDEV("p",{className:"text-green-600 text-sm font-mono mt-2",children:se?"请尝试其他搜索关键词":"点击上方按钮添加第一个用户"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1647,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1642,columnNumber:11},this),pe&&xe&&t.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:t.jsxDEV("div",{className:"bg-gray-900 border border-yellow-400 rounded-lg p-6 w-full max-w-md",children:[t.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[t.jsxDEV(o,{className:"text-yellow-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1658,columnNumber:17},this),t.jsxDEV("h2",{className:"text-xl font-bold text-yellow-400 font-mono",children:"确认角色修改"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1659,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1657,columnNumber:15},this),t.jsxDEV("div",{className:"mb-6",children:[t.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:["确定要将用户 ",t.jsxDEV("span",{className:"text-green-400 font-bold",children:['"',xe.user.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1666,columnNumber:26},this)," 的角色从",t.jsxDEV("span",{className:"text-blue-400 font-bold",children:['"',xe.oldRole.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1667,columnNumber:19},this)," 修改为",t.jsxDEV("span",{className:"text-purple-400 font-bold",children:['"',xe.newRole.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1668,columnNumber:19},this)," 吗？"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1665,columnNumber:17},this),xe.pendingRecords&&xe.pendingRecords.length>0?t.jsxDEV("div",{className:"space-y-3",children:[t.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"⚠️ 数据转移："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1674,columnNumber:23},this),t.jsxDEV("p",{className:"text-xs mb-2",children:["检测到",xe.pendingRecords.length,"条待审核工时记录需要转移。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1675,columnNumber:23},this),t.jsxDEV("p",{className:"text-yellow-200 text-xs",children:["涉及员工：",null==(x=xe.userNames)?void 0:x.join("、")]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1676,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1673,columnNumber:21},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-2",children:"选择数据接收人："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1681,columnNumber:23},this),t.jsxDEV("select",{value:fe,onChange:e=>ve(e.target.value),className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[t.jsxDEV("option",{value:"",children:"请选择接收人"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1690,columnNumber:25},this),null==(y=xe.sameRoleUsers)?void 0:y.map(e=>t.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1692,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1684,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1680,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1672,columnNumber:19},this):t.jsxDEV("div",{className:"text-green-300 font-mono text-sm mb-2 p-3 bg-green-900/20 border border-green-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"✅ 安全修改："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1701,columnNumber:21},this),t.jsxDEV("p",{className:"text-xs",children:["该",xe.oldRole.name,"没有待审核的工时记录，可以安全修改角色。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1702,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1700,columnNumber:19},this),t.jsxDEV("p",{className:"text-yellow-300 font-mono text-sm mt-2",children:"角色修改后将影响用户的权限和功能访问。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1706,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1664,columnNumber:15},this),t.jsxDEV("div",{className:"flex gap-3",children:[t.jsxDEV("button",{onClick:async()=>{var e,t;if(xe.user&&fe)try{const s="班长"===(null==(e=xe.oldRole)?void 0:e.name)?"supervisor_id":"section_chief_id",{error:m}=await R.from("timesheet_records").update({[s]:fe}).in("id",xe.pendingRecords.map(e=>e.id));if(m)throw new Error("数据转移失败，请稍后重试");const{error:n}=await R.from("users").update({phone:oe.phone,id_card:oe.id_card,name:oe.name,company_id:oe.company_id,role_id:oe.role_id,production_line:oe.production_line||null,is_active:oe.is_active,updated_at:(new Date).toISOString()}).eq("id",xe.user.id);if(n)throw n;const a=null==(t=xe.sameRoleUsers.find(e=>e.id===fe))?void 0:t.name;S.success("角色修改成功！已将".concat(xe.pendingRecords.length,"条待审核数据转移给").concat(a)),be(!1),ye({user:null,oldRole:null,newRole:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),ve(""),Pe(),await Re()}catch(s){S.error(s.message||"角色修改失败")}else S.error("请选择数据接收人")},disabled:(null==(f=xe.pendingRecords)?void 0:f.length)>0&&!fe,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-500 disabled:bg-yellow-800 disabled:cursor-not-allowed text-white font-bold rounded transition-colors font-mono",children:[t.jsxDEV(u,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1717,columnNumber:19},this),"确认修改"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1712,columnNumber:17},this),t.jsxDEV("button",{onClick:()=>{be(!1),ye({user:null,oldRole:null,newRole:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),ve(""),ue(!1)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1720,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1711,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1656,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1655,columnNumber:11},this),he&&de&&t.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:t.jsxDEV("div",{className:"bg-gray-900 border border-red-400 rounded-lg p-6 w-full max-w-md",children:[t.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[t.jsxDEV(o,{className:"text-red-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1736,columnNumber:17},this),t.jsxDEV("h2",{className:"text-xl font-bold text-red-400 font-mono",children:"确认删除"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1737,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1735,columnNumber:15},this),t.jsxDEV("div",{className:"mb-6",children:[t.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:["确定要删除用户 ",t.jsxDEV("span",{className:"text-green-400 font-bold",children:['"',de.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1744,columnNumber:27},this)," 吗？"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1743,columnNumber:17},this),"员工"===(null==(v=de.role)?void 0:v.name)?t.jsxDEV("div",{className:"text-blue-300 font-mono text-sm mb-2 p-3 bg-blue-900/20 border border-blue-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"ℹ️ 员工处理影响："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1750,columnNumber:21},this),t.jsxDEV("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[t.jsxDEV("li",{children:"保留历史工时记录和审批历史记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1752,columnNumber:23},this),t.jsxDEV("li",{children:"断开数据关联，账户设为非激活状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1753,columnNumber:23},this),t.jsxDEV("li",{children:"重新申请时不关联旧数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1754,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1751,columnNumber:21},this),t.jsxDEV("p",{className:"text-blue-200 text-xs mt-2",children:"员工处理对系统数据影响较小，数据完整性得到保护"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1756,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1749,columnNumber:19},this):"班长"===(null==(w=de.role)?void 0:w.name)||"段长"===(null==(E=de.role)?void 0:E.name)?de.pendingRecords&&de.pendingRecords.length>0?t.jsxDEV("div",{className:"space-y-3",children:[t.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"⚠️ 数据转移："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1762,columnNumber:25},this),t.jsxDEV("p",{className:"text-xs mb-2",children:["检测到",de.pendingRecords.length,"条待审核工时记录需要转移。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1763,columnNumber:25},this),t.jsxDEV("p",{className:"text-yellow-200 text-xs",children:["涉及员工：",null==(k=de.userNames)?void 0:k.join("、")]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1764,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1761,columnNumber:23},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-2",children:"选择数据接收人："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1769,columnNumber:25},this),t.jsxDEV("select",{value:Ie,onChange:e=>qe(e.target.value),className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[t.jsxDEV("option",{value:"",children:"请选择接收人"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1778,columnNumber:27},this),null==(_=de.sameRoleUsers)?void 0:_.map(e=>t.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1780,columnNumber:29},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1772,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1768,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1760,columnNumber:21},this):t.jsxDEV("div",{className:"text-green-300 font-mono text-sm mb-2 p-3 bg-green-900/20 border border-green-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"✅ 安全删除："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1789,columnNumber:23},this),t.jsxDEV("p",{className:"text-xs",children:["该",null==(D=de.role)?void 0:D.name,"没有待审核的工时记录，可以安全删除。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1790,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1788,columnNumber:21},this):"生产经理"===(null==(j=de.role)?void 0:j.name)||"财务"===(null==(M=de.role)?void 0:M.name)?t.jsxDEV("div",{className:"text-purple-300 font-mono text-sm mb-2 p-3 bg-purple-900/20 border border-purple-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:["ℹ️ ",null==(C=de.role)?void 0:C.name,"删除影响："]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1795,columnNumber:21},this),t.jsxDEV("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[t.jsxDEV("li",{children:"直接删除用户账户，不影响工时数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1797,columnNumber:23},this),t.jsxDEV("li",{children:"清理相关的审批历史记录引用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1798,columnNumber:23},this),t.jsxDEV("li",{children:"不需要数据转移或特殊处理"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1799,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1796,columnNumber:21},this),t.jsxDEV("p",{className:"text-purple-200 text-xs mt-2",children:[null==(I=de.role)?void 0:I.name,"删除对工时管理系统影响较小"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1801,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1794,columnNumber:19},this):t.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm mb-2 p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"⚠️ 删除操作将会："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1805,columnNumber:21},this),t.jsxDEV("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[t.jsxDEV("li",{children:"清理该用户在工时记录中的相关引用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1807,columnNumber:23},this),t.jsxDEV("li",{children:"删除该用户的审批历史记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1808,columnNumber:23},this),t.jsxDEV("li",{children:"永久删除用户账户信息"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1809,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1806,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1804,columnNumber:19},this),t.jsxDEV("p",{className:"text-red-300 font-mono text-sm mt-2",children:"此操作不可恢复，请谨慎操作。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1814,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1742,columnNumber:15},this),t.jsxDEV("div",{className:"flex gap-3",children:[t.jsxDEV("button",{onClick:async()=>{var e,t,s,m;if(de)try{const n=de.role;if(de.pendingRecords&&de.pendingRecords.length>0){if(!Ie)return void S.error("请选择数据接收人");const s="班长"===(null==n?void 0:n.name)?"supervisor_id":"section_chief_id",m="班长"===(null==n?void 0:n.name)?["pending","待审核","submitted","已提交"]:["approved"],{error:a}=await R.from("timesheet_records").update({[s]:Ie}).eq(s,de.id).in("status",m);if(a)return void S.error("数据转移失败，请稍后重试");null==(t=null==(e=de.sameRoleUsers)?void 0:e.find(e=>e.id===Ie))||t.name}if("员工"===(null==n?void 0:n.name)){const{error:e}=await R.from("timesheet_records").update({user_id:null}).eq("user_id",de.id);if(e)throw new Error("断开工时记录关联失败："+e.message);const{error:t}=await R.from("approval_history").update({approver_id:null}).eq("approver_id",de.id);if(t)throw new Error("断开审批历史关联失败："+t.message)}else{const{error:e}=await R.from("timesheet_records").update({supervisor_id:null}).eq("supervisor_id",de.id);if(e)throw new Error("清理工时记录引用失败："+e.message);const{error:t}=await R.from("timesheet_records").update({section_chief_id:null}).eq("section_chief_id",de.id);if(t)throw new Error("清理工时记录引用失败："+t.message);const{error:s}=await R.from("approval_history").update({approver_id:null}).eq("approver_id",de.id);if(s)throw new Error("清理审核历史引用失败："+s.message)}const{error:a}=await R.rpc("update_user_names_before_delete",{user_id_to_delete:de.id});if(a)throw new Error("更新历史记录姓名字段失败："+a.message);const{data:r,error:i}=await R.from("users").delete().eq("id",de.id).select("*");if(i)throw i;if(de.pendingRecords&&de.pendingRecords.length>0){const e=null==(m=null==(s=de.sameRoleUsers)?void 0:s.find(e=>e.id===Ie))?void 0:m.name;S.success("用户删除成功，已将".concat(de.pendingRecords.length,"条待审核工时记录转移给").concat(e,"，历史记录已保留姓名信息"))}else S.success("".concat((null==n?void 0:n.name)||"用户"," ").concat(de.name," 删除成功：用户账户已永久删除，历史记录已保留姓名信息"));ge(!1),Ne(null),qe(""),await Re()}catch(n){let e="删除用户失败";n.message&&(e=n.message.includes("foreign key constraint")?"删除失败：该用户仍有关联的数据记录，请联系系统管理员":n.message.includes("permission denied")?"删除失败：权限不足，请检查您的操作权限":n.message.includes("清理工时记录引用失败")?"删除失败：清理工时记录关联数据时出错":n.message.includes("清理审核历史引用失败")?"删除失败：清理审核历史数据时出错":"删除失败：".concat(n.message)),Ve(e),S.error(e),ge(!1),Ne(null)}},disabled:(null==(q=de.pendingRecords)?void 0:q.length)>0&&!Ie,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-500 disabled:bg-red-800 disabled:cursor-not-allowed text-white font-bold rounded transition-colors font-mono",children:[t.jsxDEV(l,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1825,columnNumber:19},this),"员工"===(null==(O=de.role)?void 0:O.name)?"确认处理":"确认删除"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1820,columnNumber:17},this),t.jsxDEV("button",{onClick:()=>{ge(!1),Ne(null)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1828,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1819,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1734,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1733,columnNumber:11},this),we&&ke&&t.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:t.jsxDEV("div",{className:"bg-gray-900 border border-blue-400 rounded-lg p-6 w-full max-w-md",children:[t.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[t.jsxDEV(o,{className:"text-blue-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1844,columnNumber:17},this),t.jsxDEV("h2",{className:"text-xl font-bold text-blue-400 font-mono",children:"确认生产线变更"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1845,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1843,columnNumber:15},this),t.jsxDEV("div",{className:"mb-6",children:[t.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:["确定要将用户 ",t.jsxDEV("span",{className:"text-green-400 font-bold",children:['"',ke.user.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1852,columnNumber:26},this)," 的生产线从",t.jsxDEV("span",{className:"text-blue-400 font-bold",children:['"',ke.oldProductionLine,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1853,columnNumber:19},this)," 变更为",t.jsxDEV("span",{className:"text-purple-400 font-bold",children:['"',ke.newProductionLine,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1854,columnNumber:19},this)," 吗？"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1851,columnNumber:17},this),ke.pendingRecords&&ke.pendingRecords.length>0?t.jsxDEV("div",{className:"space-y-3",children:[t.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"⚠️ 数据转移："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1860,columnNumber:23},this),t.jsxDEV("p",{className:"text-xs mb-2",children:["检测到",ke.pendingRecords.length,"条待审核工时记录需要转移到原生产线(",ke.oldProductionLine,")的相同角色下。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1861,columnNumber:23},this),t.jsxDEV("p",{className:"text-yellow-200 text-xs",children:["涉及员工：",null==(P=ke.userNames)?void 0:P.join("、")]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1862,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1859,columnNumber:21},this),t.jsxDEV("div",{children:[t.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-2",children:["选择原生产线的",null==(A=ke.role)?void 0:A.name,"作为数据接收人："]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1867,columnNumber:23},this),t.jsxDEV("select",{value:De,onChange:e=>je(e.target.value),className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[t.jsxDEV("option",{value:"",children:"请选择接收人"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1876,columnNumber:25},this),null==(T=ke.sameRoleUsers)?void 0:T.map(e=>t.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1878,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1870,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1866,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1858,columnNumber:19},this):t.jsxDEV("div",{className:"text-green-300 font-mono text-sm mb-2 p-3 bg-green-900/20 border border-green-600 rounded",children:[t.jsxDEV("p",{className:"mb-1",children:"✅ 安全变更："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1887,columnNumber:21},this),t.jsxDEV("p",{className:"text-xs",children:["该",null==(L=ke.role)?void 0:L.name,"没有待审核的工时记录，可以安全变更生产线。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1888,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1886,columnNumber:19},this),t.jsxDEV("p",{className:"text-blue-300 font-mono text-sm mt-2",children:"生产线变更后将影响用户的工作范围和审批权限。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1892,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1850,columnNumber:15},this),t.jsxDEV("div",{className:"flex gap-3",children:[t.jsxDEV("button",{onClick:async()=>{var e,t,s,m;if(ke.user&&De)try{if(ke.pendingRecords&&ke.pendingRecords.length>0){const m="班长"===(null==(e=ke.role)?void 0:e.name)?"supervisor_id":"section_chief_id",n="班长"===(null==(t=ke.role)?void 0:t.name)?["pending","待审核","submitted","已提交"]:["approved"],{error:a}=await R.from("timesheet_records").update({[m]:De}).eq(m,ke.user.id).in("status",n);if(a)throw new Error("数据转移失败，请稍后重试");const r=null==(s=ke.sameRoleUsers.find(e=>e.id===De))?void 0:s.name;for(const e of ke.pendingRecords){const{error:t}=await R.from("approval_history").insert({timesheet_record_id:e.id,approver_id:Ue.id,approver_name:Ue.name,action:"transfer",comment:"生产线变更：将审核权限从 ".concat(ke.user.name,"(").concat(ke.oldProductionLine,") 转移给 ").concat(r,"(").concat(ke.oldProductionLine,")"),created_at:(new Date).toISOString()})}}const{error:n}=await R.from("users").update({phone:oe.phone,id_card:oe.id_card,name:oe.name,company_id:oe.company_id,role_id:oe.role_id,production_line:oe.production_line||null,is_active:oe.is_active,updated_at:(new Date).toISOString()}).eq("id",ke.user.id);if(n)throw n;if(ke.pendingRecords&&ke.pendingRecords.length>0){const e=null==(m=ke.sameRoleUsers.find(e=>e.id===De))?void 0:m.name;S.success("生产线变更成功！已将".concat(ke.pendingRecords.length,"条待审核数据转移给").concat(e))}else S.success("生产线变更成功！");Ee(!1),_e({user:null,oldProductionLine:"",newProductionLine:"",role:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),je(""),Pe(),await Re()}catch(n){S.error(n.message||"生产线变更失败")}else S.error("请选择数据接收人")},disabled:(null==(G=ke.pendingRecords)?void 0:G.length)>0&&!De,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:cursor-not-allowed text-white font-bold rounded transition-colors font-mono",children:[t.jsxDEV(u,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1903,columnNumber:19},this),"确认变更"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1898,columnNumber:17},this),t.jsxDEV("button",{onClick:()=>{Ee(!1),_e({user:null,oldProductionLine:"",newProductionLine:"",role:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),je(""),ue(!1)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1906,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1897,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1842,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1841,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1285,columnNumber:7},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1284,columnNumber:5},this)}},Symbol.toStringTag,{value:"Module"}));export{F as A,H as C,O as D,I as P,q as S,Z as U,P as c,G as f,z as g,Y as h,J as i,R as s,X as u};
