import{j as e,X as t,f as m,r as s,l as n,e as r,i,n as o,U as a,F as l}from"./react-vendor-DNzT5kIg.js";import{t as c}from"./toast-B5TM6ihQ.js";import{u as h,i as u,s as d}from"./index-wwgaFQ6Z.js";import"./vendor-DLvgz_hY.js";import"./supabase-BSlBLnmQ.js";function g({isOpen:m,onClose:s,onConfirm:n,record:r,items:i,productionLines:o,supervisors:a,sectionLeaders:l,workTypes:c,products:h,processes:u}){if(!m)return null;const d=e=>{var t;return(null==(t=c.find(t=>t.id===e))?void 0:t.name)||"未知工时类型"},g=e=>{var t;return(null==(t=h.find(t=>t.id===e))?void 0:t.name)||"未知产品"},N=e=>{var t;return(null==(t=u.find(t=>t.id===e))?void 0:t.product_process)||"未知工序"};return e.jsxDEV("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:[e.jsxDEV("div",{className:"flex justify-between items-center mb-6",children:[e.jsxDEV("h2",{className:"text-xl font-bold text-green-400",children:"确认提交工时记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:86,columnNumber:11},this),e.jsxDEV("button",{onClick:s,className:"text-gray-400 hover:text-white transition-colors",children:e.jsxDEV(t,{className:"w-6 h-6"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:91,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:87,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:85,columnNumber:9},this),e.jsxDEV("div",{className:"space-y-6",children:[e.jsxDEV("div",{className:"bg-gray-800 border border-green-400 rounded-lg p-4",children:[e.jsxDEV("h3",{className:"text-lg font-semibold text-green-300 mb-4",children:"基本信息"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:98,columnNumber:13},this),e.jsxDEV("div",{className:"space-y-2",children:[e.jsxDEV("div",{className:"flex justify-between",children:[e.jsxDEV("div",{children:[e.jsxDEV("span",{className:"text-green-300 font-medium",children:"记录日期："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:103,columnNumber:19},this),e.jsxDEV("span",{className:"text-white",children:r.record_date},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:104,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:102,columnNumber:17},this),e.jsxDEV("div",{children:[e.jsxDEV("span",{className:"text-green-300 font-medium",children:"生产线："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:107,columnNumber:19},this),e.jsxDEV("span",{className:"text-white",children:(p=r.production_line_id,p?(null==(y=o.find(e=>e.id===p))?void 0:y.name)||"未知生产线":"未选择")},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:108,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:106,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:101,columnNumber:15},this),e.jsxDEV("div",{className:"flex justify-between",children:[e.jsxDEV("div",{children:[e.jsxDEV("span",{className:"text-green-300 font-medium",children:"班次："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:114,columnNumber:19},this),e.jsxDEV("span",{className:"text-white",children:(b=r.shift_type,"白班"===b||"day"===b?"白班":"夜班"===b||"night"===b?"夜班":"未知班次")},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:115,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:113,columnNumber:17},this),e.jsxDEV("div",{},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:117,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:112,columnNumber:15},this),e.jsxDEV("div",{className:"flex justify-between",children:[e.jsxDEV("div",{children:[e.jsxDEV("span",{className:"text-green-300 font-medium",children:"班长："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:122,columnNumber:19},this),e.jsxDEV("span",{className:"text-white",children:(e=>{var t;return e?(null==(t=a.find(t=>t.id.toString()===e))?void 0:t.name)||"未知班长":"未选择"})(r.supervisor_id)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:123,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:121,columnNumber:17},this),e.jsxDEV("div",{children:[e.jsxDEV("span",{className:"text-green-300 font-medium",children:"段长："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:126,columnNumber:19},this),e.jsxDEV("span",{className:"text-white",children:(e=>{var t;return e?(null==(t=l.find(t=>t.id.toString()===e))?void 0:t.name)||"未知段长":"未选择"})(r.section_chief_id)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:127,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:125,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:120,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:99,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:97,columnNumber:11},this),e.jsxDEV("div",{className:"bg-gray-800 border border-green-400 rounded-lg p-4",children:[e.jsxDEV("h3",{className:"text-lg font-semibold text-green-300 mb-4",children:["工时记录项 (",i.length,"项)"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:135,columnNumber:13},this),e.jsxDEV("div",{className:"overflow-x-auto",children:e.jsxDEV("table",{className:"w-full text-sm",children:[e.jsxDEV("thead",{children:e.jsxDEV("tr",{className:"border-b border-green-400",children:[e.jsxDEV("th",{className:"text-left text-green-300 py-2 px-2",children:"序号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:140,columnNumber:21},this),e.jsxDEV("th",{className:"text-left text-green-300 py-2 px-2",children:"工时类型"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:141,columnNumber:21},this),e.jsxDEV("th",{className:"text-left text-green-300 py-2 px-2",children:"产品名称"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:142,columnNumber:21},this),e.jsxDEV("th",{className:"text-left text-green-300 py-2 px-2",children:"工序名称"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:143,columnNumber:21},this),e.jsxDEV("th",{className:"text-left text-green-300 py-2 px-2",children:"数量"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:144,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:139,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:138,columnNumber:17},this),e.jsxDEV("tbody",{children:i.map((t,m)=>e.jsxDEV("tr",{className:"border-b border-gray-600",children:[e.jsxDEV("td",{className:"py-2 px-2 text-white",children:m+1},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:150,columnNumber:23},this),e.jsxDEV("td",{className:"py-2 px-2 text-white",children:d(t.work_type_id)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:151,columnNumber:23},this),e.jsxDEV("td",{className:"py-2 px-2 text-white",children:g(t.product_id)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:152,columnNumber:23},this),e.jsxDEV("td",{className:"py-2 px-2 text-white",children:N(t.process_id)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:153,columnNumber:23},this),e.jsxDEV("td",{className:"py-2 px-2 text-white",children:t.quantity},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:154,columnNumber:23},this)]},m,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:149,columnNumber:21},this))},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:147,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:137,columnNumber:15},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:136,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:134,columnNumber:11},this),e.jsxDEV("div",{className:"bg-yellow-900/30 border border-yellow-600 rounded-lg p-2 mb-4",children:e.jsxDEV("p",{className:"text-yellow-300 text-xs",children:"⚠️ 数据提交后将不可修改，请仔细核对以上信息是否正确。数据确认提交后，需要等待班长和段长审核通过。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:164,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:163,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:95,columnNumber:9},this),e.jsxDEV("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsxDEV("button",{onClick:s,className:"px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:172,columnNumber:11},this),e.jsxDEV("button",{onClick:n,className:"px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors",children:"确认提交"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:178,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:171,columnNumber:9},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:84,columnNumber:7},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/components/TimesheetConfirmDialog.tsx",lineNumber:83,columnNumber:5},this);var b,p,y}function N(){const{user:t,isAuthenticated:N,refreshUser:b}=h(),p=m(),[y,f]=s.useState(!0),[x,v]=s.useState([]),[w,k]=s.useState([]),[_,T]=s.useState([]),[R,C]=s.useState([]),[D,j]=s.useState([]),[I,q]=s.useState([]),[O,F]=s.useState([]),[L,B]=s.useState(null),[S,z]=s.useState([]),[A,U]=s.useState([]),[E,M]=s.useState({user_id:(null==t?void 0:t.id)||"",record_date:(new Date).toISOString().split("T")[0],production_line_id:0,supervisor_id:null,section_chief_id:null,shift_type:"白班",status:"draft",items:[]}),[P,W]=s.useState({work_type_id:0,product_id:0,process_id:"",quantity:0}),[G,H]=s.useState(""),J=()=>({work_type_id:w.length>0?w[0].id:1,product_id:0,process_id:"",quantity:0}),[K,Q]=s.useState([J()]),[V,X]=s.useState({}),[Y,Z]=s.useState({}),[$,ee]=s.useState(!1),[te,me]=s.useState(!1),se=async()=>{if(t)try{const{data:e,error:m}=await d.from("users").select("company_id").eq("id",t.id).single();if(m)throw m;B(e.company_id)}catch(e){c.error("获取用户公司信息失败")}};s.useEffect(()=>{t&&ne()},[t]),s.useEffect(()=>{E.production_line_id?(M(e=>({...e,supervisor_id:null,section_chief_id:null})),ce(E.production_line_id.toString()),he(E.production_line_id.toString())):(q([]),F([]),M(e=>({...e,supervisor_id:null,section_chief_id:null})))},[E.production_line_id,x]),s.useEffect(()=>{E.production_line_id?(W(e=>({...e,work_type_id:0,product_id:0,process_id:""})),H(""),ie(),oe(),ae()):(k([]),T([]),C([]),W(e=>({...e,work_type_id:0,product_id:0,process_id:""})),H(""))},[E.production_line_id,x]),s.useEffect(()=>{1===x.length&&0===E.production_line_id&&M(e=>({...e,production_line_id:x[0].id}))},[x,E.production_line_id]),s.useEffect(()=>{if(E.production_line_id&&!E.supervisor_id&&D.length>0&&L){const e=D.filter(e=>{var t;if("班长"!==(null==(t=e.role)?void 0:t.name))return!1;if(e.company_id!==L)return!1;if(E.production_line_id){const e=x.find(e=>e.id===E.production_line_id);if(e)return R.filter(t=>t.production_line===e.name).length>0}return!0});1===e.length&&M(t=>({...t,supervisor_id:e[0].id}))}},[E.production_line_id,E.supervisor_id,D,L,x,R]),s.useEffect(()=>{if(E.production_line_id&&!E.section_chief_id&&D.length>0&&L){const e=D.filter(e=>{var t;if("段长"!==(null==(t=e.role)?void 0:t.name))return!1;if(e.company_id!==L)return!1;if(E.production_line_id){const e=x.find(e=>e.id===E.production_line_id);if(e)return R.filter(t=>t.production_line===e.name).length>0}return!0});1===e.length&&M(t=>({...t,section_chief_id:e[0].id}))}},[E.production_line_id,E.section_chief_id,D,L,x,R]),s.useEffect(()=>{if(w.length>0&&E.production_line_id&&R.length>0){const e=w.find(e=>e.id===P.work_type_id);if(!e&&w.length>0)return void W(e=>({...e,work_type_id:w[0].id}));if(e){const e=P.work_type_id;de(e)}}},[w,E.production_line_id,R,P.work_type_id]),s.useEffect(()=>{1===_.length&&0===P.product_id&&W(e=>({...e,product_id:_[0].id}))},[_,P.product_id]),s.useEffect(()=>{1===R.length&&""===P.process_id&&W(e=>({...e,process_id:R[0].id}))},[R,P.process_id]);const ne=async()=>{if(t)try{f(!0),await Promise.all([se(),re(),le()])}catch(e){c.error("加载数据失败")}finally{f(!1)}},re=async()=>{if(t)try{const e=u(t.role);let m=d.from("processes").select("id, production_line, company_id, is_active").eq("is_active",!0).order("production_line");if(e);else{const{data:e,error:s}=await d.from("users").select("company_id").eq("id",t.id).single();if(s)throw s;m=m.eq("company_id",e.company_id)}const{data:s,error:n}=await m;if(n)throw n;const r=new Map;null==s||s.forEach(e=>{e.production_line&&r.set(e.production_line,{company_id:e.company_id,is_active:e.is_active})});const i=Array.from(r.entries()).map(([e,t],m)=>({id:m+1,name:e,is_active:t.is_active,company_id:t.company_id}));v(i)}catch(e){c.error("加载生产线信息失败")}},ie=async()=>{if(t)try{if(!E.production_line_id)return void k([]);const e=x.find(e=>e.id===E.production_line_id);if(!e)return void k([]);let m;if(u(t.role)){if(!e.company_id)return void k([]);m=e.company_id}else{const{data:e,error:s}=await d.from("users").select("company_id").eq("id",t.id).single();if(s)throw s;m=e.company_id}const{data:s,error:n}=await d.from("processes").select("production_category").eq("company_id",m).eq("production_line",e.name).eq("is_active",!0).not("production_category","is",null);if(n)throw n;const r=[...new Set((null==s?void 0:s.map(e=>e.production_category))||[])].filter(e=>e&&isNaN(+e)).sort().map((e,t)=>({id:t+1,name:e,is_active:!0}));k(r)}catch(e){c.error("加载工时类型数据失败")}},oe=async()=>{if(t)try{if(!E.production_line_id)return void T([]);const e=x.find(e=>e.id===E.production_line_id);if(!e)return void T([]);let m;if(u(t.role)){if(!e.company_id)return void T([]);m=e.company_id}else{const{data:e,error:s}=await d.from("users").select("company_id").eq("id",t.id).single();if(s)throw s;m=e.company_id}const{data:s,error:n}=await d.from("processes").select("id, product_name, production_line").eq("company_id",m).eq("production_line",e.name).eq("is_active",!0);if(n)throw n;const r=[...new Set((null==s?void 0:s.map(e=>e.product_name))||[])].filter(Boolean).sort().map((e,t)=>({id:t+1,name:e,code:"",is_active:!0}));T(r)}catch(e){c.error("加载产品数据失败")}},ae=async()=>{if(t)try{if(!E.production_line_id)return void C([]);const e=x.find(e=>e.id===E.production_line_id);if(!e)return void C([]);let m;if(u(t.role)){if(!e.company_id)return void C([]);m=e.company_id}else{const{data:e,error:s}=await d.from("users").select("company_id").eq("id",t.id).single();if(s)throw s;m=e.company_id}const{data:s,error:n}=await d.from("processes").select("id, product_process, product_name, company_id, production_line, production_category, unit_price, is_active").eq("company_id",m).eq("production_line",e.name).eq("is_active",!0).order("product_process");if(n)throw n;const r=(null==s?void 0:s.map(e=>({id:e.id,name:e.product_process,product_name:e.product_name,company_id:e.company_id,production_line:e.production_line,production_category:e.production_category,product_process:e.product_process,unit_price:e.unit_price,is_active:e.is_active})))||[];C(r)}catch(e){c.error("加载工序数据失败")}},le=async()=>{const{data:e,error:t}=await d.from("users").select("id, name, company_id, production_line, role:user_roles!inner(name)").eq("is_active",!0).order("name");if(t)throw t;j(e||[])},ce=async e=>{if(e)try{const t=x.find(t=>t.id===parseInt(e));if(!t)return void q([]);const{data:m,error:s}=await d.from("users").select("\n          id, \n          name, \n          production_line,\n          role:user_roles!inner(name)\n        ").eq("production_line",t.name).eq("user_roles.name","班长").eq("is_active",!0).order("name");if(s)throw s;q(m||[]),m&&1===m.length&&!E.supervisor_id&&M(e=>({...e,supervisor_id:m[0].id}))}catch(t){c.error("加载班长数据失败"),q([])}else q([])},he=async e=>{if(e)try{const t=x.find(t=>t.id===parseInt(e));if(!t)return void F([]);const{data:m,error:s}=await d.from("users").select("\n          id, \n          name, \n          production_line,\n          role:user_roles!inner(name)\n        ").eq("production_line",t.name).eq("user_roles.name","段长").eq("is_active",!0).order("name");if(s)throw s;F(m||[]),m&&1===m.length&&!E.section_chief_id&&M(e=>({...e,section_chief_id:m[0].id}))}catch(t){c.error("加载段长数据失败"),F([])}else F([])},ue=(e,t)=>{M(m=>{let s=t;"production_line_id"===e?s=parseInt(t)||0:"supervisor_id"!==e&&"section_chief_id"!==e||(s=t||null);const n={...m,[e]:s};return"production_line_id"===e&&(n.supervisor_id=null,n.section_chief_id=null),n})},de=e=>{if(W(t=>({...t,work_type_id:e,product_id:0,process_id:""})),H(""),0===e)return z([]),void U([]);const t=w.find(t=>t.id===e);if(!t)return z([]),void U([]);const m=ge();if(m){const e=R.filter(e=>{const s=e.production_line===m,n=e.production_category===t.name;return s&&n}).map(e=>e.product_name).filter((e,t,m)=>e&&m.indexOf(e)===t).filter(Boolean);z(e)}else z([]);U([])},ge=()=>{if(E.production_line_id){const e=x.find(e=>e.id===E.production_line_id);return null==e?void 0:e.name}return null},Ne=(e,t,m)=>{Q(s=>{const n=[...s];let r=m;return"work_type_id"===t||"product_id"===t?r=parseInt(m)||0:"process_id"===t?r=m||"":"quantity"===t&&(r=parseFloat(m)||0),n[e]={...n[e],[t]:r},"work_type_id"===t?(n[e].product_id=0,n[e].process_id="",X(t=>({...t,[e]:""}))):"product_id"===t&&(n[e].process_id=""),n})},be=e=>{if(!e||!E.production_line_id)return[];const t=w.find(t=>t.id===e),m=ge();if(!t||!m)return[];const s=R.filter(e=>e.production_line===m&&e.production_category===t.name&&e.is_active);return[...new Set(s.map(e=>e.product_name))].map((e,t)=>({id:t+1,name:e}))},pe=(e,t)=>{if(!e)return[];const m=ge();if(!m)return[];const s=(t?be(t):[]).find(t=>t.id===e);return s?R.filter(e=>e.production_line===m&&e.product_name===s.name&&e.is_active):[]};return e.jsxDEV("div",{className:"min-h-screen bg-black text-green-400 font-mono",children:[e.jsxDEV("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxDEV("div",{className:"mb-4 sm:mb-8",children:[e.jsxDEV("div",{className:"flex justify-between items-center mb-2 sm:mb-4",children:[e.jsxDEV("div",{className:"flex items-center",children:[e.jsxDEV(n,{className:"w-5 h-5 sm:w-8 sm:h-8 text-green-400 mr-2 sm:mr-3"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1580,columnNumber:15},this),e.jsxDEV("h1",{className:"text-xl sm:text-4xl font-bold text-green-400 font-mono",children:"工时记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1581,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1579,columnNumber:13},this),e.jsxDEV("div",{className:"flex items-center space-x-2",children:[e.jsxDEV("button",{onClick:async()=>{me(!0);try{M({user_id:(null==t?void 0:t.id)||"",record_date:(new Date).toISOString().split("T")[0],production_line_id:0,supervisor_id:null,section_chief_id:null,shift_type:"白班",status:"draft",items:[]}),Q([J()]),X({}),Z({}),H(""),W({work_type_id:0,product_id:0,process_id:"",quantity:0}),await ne(),c.success("数据已刷新")}catch(e){c.error("刷新失败，请重试")}finally{me(!1)}},disabled:te,className:"flex items-center space-x-1 sm:space-x-2 px-2 py-1 sm:px-4 sm:py-2 bg-gradient-to-r from-gray-600 to-gray-800 hover:from-gray-500 hover:to-gray-700 disabled:from-gray-600 disabled:to-gray-800 text-green-300 border border-green-400 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 font-mono text-sm sm:text-base disabled:cursor-not-allowed",children:[e.jsxDEV(r,{className:"w-4 h-4 sm:w-5 sm:h-5 ".concat(te?"animate-spin":"")},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1589,columnNumber:17},this),e.jsxDEV("span",{className:"hidden sm:inline",children:te?"刷新中...":"刷新"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1590,columnNumber:17},this),e.jsxDEV("span",{className:"sm:hidden",children:te?"...":"刷新"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1591,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1584,columnNumber:15},this),e.jsxDEV(i,{to:"/dashboard",className:"flex items-center space-x-1 sm:space-x-2 px-2 py-1 sm:px-4 sm:py-2 bg-gradient-to-r from-gray-600 to-gray-800 hover:from-gray-500 hover:to-gray-700 text-green-300 border border-green-400 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 font-mono text-sm sm:text-base",children:[e.jsxDEV(o,{className:"w-4 h-4 sm:w-5 sm:h-5"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1597,columnNumber:17},this),e.jsxDEV("span",{className:"hidden sm:inline",children:"返回控制台"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1598,columnNumber:17},this),e.jsxDEV("span",{className:"sm:hidden",children:"返回"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1599,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1593,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1583,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1578,columnNumber:11},this),e.jsxDEV("div",{className:"h-0.5 sm:h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1603,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1577,columnNumber:9},this),e.jsxDEV("div",{className:"space-y-3 sm:space-y-6",children:e.jsxDEV("div",{className:"flex flex-col lg:flex-row gap-3 sm:gap-6",children:[e.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg p-3 sm:p-6 flex-1",children:[e.jsxDEV("h2",{className:"text-lg sm:text-xl font-bold text-green-400 mb-2 sm:mb-4 flex items-center gap-2",children:[e.jsxDEV(a,{className:"w-4 h-4 sm:w-5 sm:h-5 text-green-400"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1611,columnNumber:17},this),"基本信息"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1610,columnNumber:15},this),e.jsxDEV("div",{className:"space-y-3",children:[e.jsxDEV("div",{className:"grid grid-cols-2 gap-2 sm:gap-4",children:[e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:"记录日期"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1620,columnNumber:21},this),e.jsxDEV("input",{type:"date",value:E.record_date,onChange:e=>ue("record_date",e.target.value),className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1621,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1619,columnNumber:19},this),e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["生产线 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1631,columnNumber:27},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1630,columnNumber:21},this),e.jsxDEV("select",{value:E.production_line_id||0,onChange:e=>ue("production_line_id",parseInt(e.target.value)||0),className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm",children:[e.jsxDEV("option",{value:0,children:"请选择生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1638,columnNumber:23},this),x.map(t=>e.jsxDEV("option",{value:t.id,children:t.name},t.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1640,columnNumber:25},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1633,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1629,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1618,columnNumber:17},this),e.jsxDEV("div",{className:"grid grid-cols-2 gap-2 sm:gap-4",children:[e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["班长 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1650,columnNumber:26},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1649,columnNumber:21},this),e.jsxDEV("select",{value:E.supervisor_id||"",onChange:e=>ue("supervisor_id",e.target.value||null),disabled:!E.production_line_id,className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm ".concat(E.production_line_id?"":"opacity-50 cursor-not-allowed"),children:[e.jsxDEV("option",{value:"",children:(E.production_line_id,"请选择班长")},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1660,columnNumber:23},this),I.map(t=>e.jsxDEV("option",{value:t.id,children:t.name},t.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1664,columnNumber:25},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1652,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1648,columnNumber:19},this),e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["段长 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1671,columnNumber:26},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1670,columnNumber:21},this),e.jsxDEV("select",{value:E.section_chief_id||"",onChange:e=>ue("section_chief_id",e.target.value||null),disabled:!E.production_line_id,className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm ".concat(E.production_line_id?"":"opacity-50 cursor-not-allowed"),children:[e.jsxDEV("option",{value:"",children:(E.production_line_id,"请选择段长")},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1681,columnNumber:23},this),O.map(t=>e.jsxDEV("option",{value:t.id,children:t.name},t.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1685,columnNumber:25},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1673,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1669,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1647,columnNumber:17},this),e.jsxDEV("div",{className:"grid grid-cols-1 gap-2 sm:gap-4",children:e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["班次 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1695,columnNumber:26},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1694,columnNumber:21},this),e.jsxDEV("select",{value:E.shift_type,onChange:e=>ue("shift_type",e.target.value),className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm",children:[e.jsxDEV("option",{value:"白班",children:"白班"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1702,columnNumber:23},this),e.jsxDEV("option",{value:"夜班",children:"夜班"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1703,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1697,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1693,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1692,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1616,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1609,columnNumber:13},this),e.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg p-3 sm:p-6 flex-1",children:[e.jsxDEV("h2",{className:"text-lg sm:text-xl font-bold text-green-400 mb-2 sm:mb-4 flex items-center gap-2",children:[e.jsxDEV(l,{className:"w-4 h-4 sm:w-5 sm:h-5 text-green-400"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1713,columnNumber:17},this),"添加记录"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1712,columnNumber:15},this),e.jsxDEV("div",{className:"space-y-3 sm:space-y-4",children:K.map((t,m)=>e.jsxDEV("div",{className:"bg-gray-800/50 p-3 sm:p-4 rounded-lg border border-gray-700",children:[e.jsxDEV("div",{className:"flex items-center justify-between mb-3",children:[e.jsxDEV("span",{className:"text-green-400 font-medium text-sm",children:["记录 ",m+1]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1724,columnNumber:23},this),e.jsxDEV("button",{onClick:()=>(e=>{Q(t=>{const m=t.filter((t,m)=>m!==e);return 0===m.length?[J()]:m}),X(t=>{const m={...t};delete m[e];const s={};return Object.keys(m).map(e=>parseInt(e)).filter(t=>t>e).forEach(e=>{s[e-1]=m[e]}),Object.keys(m).map(e=>parseInt(e)).filter(t=>e>t).forEach(e=>{s[e]=m[e]}),s}),Z(t=>{const m={...t};delete m[e];const s={};return Object.keys(m).map(e=>parseInt(e)).filter(t=>t>e).forEach(e=>{s[e-1]=m[e]}),Object.keys(m).map(e=>parseInt(e)).filter(t=>e>t).forEach(e=>{s[e]=m[e]}),s})})(m),className:"px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors",title:"删除此行",children:"删除"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1725,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1723,columnNumber:21},this),e.jsxDEV("div",{className:"space-y-3",children:[e.jsxDEV("div",{className:"grid grid-cols-2 gap-2 sm:gap-4",children:[e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["工时类型 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1740,columnNumber:34},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1739,columnNumber:27},this),e.jsxDEV("select",{value:t.work_type_id||0,onChange:e=>Ne(m,"work_type_id",parseInt(e.target.value)||0),className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm",children:[e.jsxDEV("option",{value:0,children:"请选择工时类型"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1747,columnNumber:29},this),w.map(t=>e.jsxDEV("option",{value:t.id,children:t.name},t.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1749,columnNumber:31},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1742,columnNumber:27},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1738,columnNumber:25},this),e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["产品名称 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1758,columnNumber:34},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1757,columnNumber:27},this),e.jsxDEV("div",{className:"relative",children:[e.jsxDEV("input",{type:"text",value:V[m]||"",onChange:e=>{const t=e.target.value;X(e=>({...e,[m]:t})),t||Ne(m,"product_id",0)},onBlur:e=>{setTimeout(()=>{Z(e=>({...e,[m]:!1}))},200);const s=e.target.value,n=be(t.work_type_id).find(e=>e.name===s);n&&Ne(m,"product_id",n.id)},onClick:e=>{t.work_type_id&&(e.currentTarget.focus(),Z(e=>({...e,[m]:!0})))},onFocus:()=>{t.work_type_id&&Z(e=>({...e,[m]:!0}))},className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm ".concat(t.work_type_id?"":"opacity-50 cursor-not-allowed"),placeholder:t.work_type_id?"请输入产品名称":"请先选择工时类型",disabled:!t.work_type_id},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1761,columnNumber:29},this),Y[m]&&t.work_type_id&&e.jsxDEV("div",{className:"absolute z-10 w-full mt-1 bg-gray-800 border border-green-400 rounded-md shadow-lg max-h-40 overflow-y-auto",children:be(t.work_type_id).filter(e=>e.name.toLowerCase().includes((V[m]||"").toLowerCase())).map(t=>e.jsxDEV("div",{onClick:()=>{X(e=>({...e,[m]:t.name})),Ne(m,"product_id",t.id),Z(e=>({...e,[m]:!1}))},className:"px-2 py-1.5 sm:px-3 sm:py-2 text-green-300 hover:bg-gray-700 cursor-pointer border-b border-gray-600 last:border-b-0 text-xs sm:text-sm",children:t.name},t.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1814,columnNumber:35},this))},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1808,columnNumber:31},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1760,columnNumber:27},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1756,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1737,columnNumber:23},this),e.jsxDEV("div",{className:"grid grid-cols-2 gap-2 sm:gap-4",children:[e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["工序名称 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1836,columnNumber:34},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1835,columnNumber:27},this),e.jsxDEV("select",{value:t.process_id||"",onChange:e=>Ne(m,"process_id",e.target.value||""),className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm ".concat(t.product_id?"":"opacity-50 cursor-not-allowed"),disabled:!t.product_id,children:[e.jsxDEV("option",{value:"",children:t.product_id?"请选择工序名称":"请先选择产品"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1846,columnNumber:29},this),pe(t.product_id,t.work_type_id).map(t=>e.jsxDEV("option",{value:t.id,children:t.product_process},t.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1850,columnNumber:31},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1838,columnNumber:27},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1834,columnNumber:25},this),e.jsxDEV("div",{children:[e.jsxDEV("label",{className:"block text-green-300 text-xs font-medium mb-1",children:["数量 ",e.jsxDEV("span",{className:"text-red-400",children:"*"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1859,columnNumber:32},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1858,columnNumber:27},this),e.jsxDEV("input",{type:"number",value:t.quantity||"",onChange:e=>Ne(m,"quantity",parseFloat(e.target.value)||0),onWheel:e=>e.currentTarget.blur(),className:"w-full px-2 py-1.5 sm:px-3 sm:py-2 bg-gray-800 border border-green-400 text-green-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-300 text-xs sm:text-sm [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none",placeholder:"请输入数量",min:"0",step:"0.01"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1861,columnNumber:27},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1857,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1833,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1735,columnNumber:21},this)]},m,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1722,columnNumber:19},this))},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1720,columnNumber:15},this),e.jsxDEV("div",{className:"mt-4 sm:mt-6 grid grid-cols-2 gap-2 sm:flex sm:justify-between sm:items-center",children:[e.jsxDEV("button",{onClick:()=>{Q(e=>[...e,J()]);const e=K.length;X(t=>({...t,[e]:""})),Z(t=>({...t,[e]:!1}))},className:"px-2 py-2 sm:px-4 sm:py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm",children:[e.jsxDEV(l,{className:"w-3 h-3 sm:w-4 sm:h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1884,columnNumber:19},this),e.jsxDEV("span",{className:"hidden sm:inline",children:"添加新记录项"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1885,columnNumber:19},this),e.jsxDEV("span",{className:"sm:hidden",children:"添加记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1886,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1880,columnNumber:17},this),e.jsxDEV("button",{onClick:()=>{if(!E.supervisor_id)return void c.error("❌ 请选择班长",{duration:4e3,description:"班长是必填项，请在基本信息中选择班长"});if(!E.section_chief_id)return void c.error("❌ 请选择段长",{duration:4e3,description:"段长是必填项，请在基本信息中选择段长"});const e=K.filter(e=>e.work_type_id&&e.process_id&&e.quantity>0);for(let t=0;t<e.length;t++){const m=e[t],s=_.find(e=>e.id===m.product_id);if(!s||!s.name||""===s.name.trim())return void c.error("❌ 产品名称不完整",{duration:4e3,description:"第 ".concat(K.indexOf(m)+1," 条记录的产品名称不完整，请重新选择产品")})}ee(!0)},className:"px-2 py-2 sm:px-6 sm:py-2 rounded-md focus:outline-none focus:ring-2 transition-colors text-xs sm:text-sm font-medium ".concat(0!==K.filter(e=>e.work_type_id&&e.process_id&&e.quantity>0).length&&E.supervisor_id&&E.section_chief_id?"bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500":"bg-gray-500 text-gray-300 cursor-not-allowed"),disabled:0===K.filter(e=>e.work_type_id&&e.process_id&&e.quantity>0).length||!E.supervisor_id||!E.section_chief_id,children:"提交审核"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1888,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1879,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1711,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1607,columnNumber:11},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1605,columnNumber:9},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1575,columnNumber:7},this),e.jsxDEV(g,{isOpen:$,onClose:()=>ee(!1),onConfirm:async()=>{ee(!1),await(async()=>{const e=K.filter(e=>e.work_type_id&&e.process_id&&e.quantity>0),m=[...E.items,...e.map(e=>({...e,total_amount:e.quantity}))];e.length>0&&c.success("成功添加 ".concat(e.length," 条工时记录")),await(async e=>{var m,s;let n;if(!t)return void c.error("❌ 用户未登录，请重新登录后再试",{duration:5e3,description:"登录状态已过期，请刷新页面重新登录"});if(!E.supervisor_id)return void c.error("❌ 请选择班长",{duration:4e3,description:"班长是必填项，请在基本信息中选择班长"});if(!E.section_chief_id)return void c.error("❌ 请选择段长",{duration:4e3,description:"段长是必填项，请在基本信息中选择段长"});const r=e||E.items;if(0!==r.length){c.loading("🔄 正在提交工时记录，请稍候...",{id:"submit-loading",description:"正在提交 ".concat(r.length," 条工时记录到审核系统")});try{f(!0);try{const{data:e,error:t}=await d.from("users").select("id").limit(1);if(t)throw Error("数据库连接失败: ".concat(t.message))}catch(i){return void c.error("数据库连接失败，请检查网络连接")}if(!(null==t?void 0:t.id))return void c.error("用户信息无效，请重新登录");n={user_id:t.id,work_date:E.record_date,supervisor_id:E.supervisor_id,section_chief_id:E.section_chief_id,shift_type:E.shift_type,status:"pending"};const{data:m,error:s}=await d.from("timesheet_records").insert(n).select().single();if(s)throw s;const r=(e||E.items).map(e=>{const t=R.find(t=>t.id===e.process_id),s=t&&null!==t.unit_price?parseFloat(t.unit_price.toString()):0;return{timesheet_record_id:m.id,process_id:e.process_id,quantity:e.quantity,unit_price:s,amount:e.quantity*s}}),{error:o}=await d.from("timesheet_record_items").insert(r);if(o)throw o;const a=I.find(e=>e.id===E.supervisor_id);null==a||a.name,c.dismiss("submit-loading"),c.success("数据提交成功返回首页",{duration:1500}),setTimeout(()=>{p("/dashboard")},1500),Q([J()]),M({user_id:t.id,record_date:(new Date).toISOString().split("T")[0],production_line_id:0,supervisor_id:null,section_chief_id:null,shift_type:"白班",status:"draft",items:[]})}catch(o){c.dismiss("submit-loading");let e="❌ 工时记录提交失败",t="请检查网络连接后重试，如问题持续请联系管理员";"42501"===(null==o?void 0:o.code)?(e="❌ 权限不足，提交失败",t="您没有权限创建工时记录，请联系管理员检查数据库权限配置。如果您是新员工，可能需要管理员为您分配相应权限。"):"23502"===(null==o?void 0:o.code)?(e="❌ 数据验证失败",t="提交的数据缺少必填字段，请检查所有必填项（生产线、班长、段长、工时记录项）是否已正确填写。"):"23503"===(null==o?void 0:o.code)?(e="❌ 数据关联错误",t="您选择的生产线、班长或段长可能已被删除或无效，请重新选择后再试。如问题持续，请联系管理员。"):"42703"===(null==o?void 0:o.code)?(e="❌ 数据格式错误",t="提交的数据格式不正确，这可能是系统版本问题，请联系技术支持。"):(null==(m=null==o?void 0:o.message)?void 0:m.includes("网络"))||(null==(s=null==o?void 0:o.message)?void 0:s.includes("连接"))?(e="❌ 网络连接失败",t="无法连接到服务器，请检查您的网络连接，稍后再试。如果问题持续，请联系IT支持。"):(null==o?void 0:o.message)&&(e="❌ 提交失败",t="错误详情: ".concat(o.message,"。请截图此错误信息并联系管理员。")),c.error(e,{duration:8e3,description:t,action:{label:"重试",onClick:()=>{ee(!0)}}})}finally{f(!1)}}else c.error("❌ 请至少添加一条工时记录",{duration:4e3,description:"工时记录不能为空，请添加至少一条有效的工时记录"})})(m)})()},record:E,items:K.filter(e=>e.work_type_id&&e.process_id&&e.quantity>0),productionLines:x,supervisors:I,sectionLeaders:O,workTypes:w,products:_,processes:R},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1911,columnNumber:7},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/TimesheetRecord.tsx",lineNumber:1574,columnNumber:5},this)}export{N as default};
