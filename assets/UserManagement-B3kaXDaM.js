var e=Object.defineProperty,s=Object.defineProperties,n=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(s,n,t)=>n in s?e(s,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[n]=t,o=(e,s)=>{for(var n in s||(s={}))m.call(s,n)&&a(e,n,s[n]);if(t)for(var n of t(s))r.call(s,n)&&a(e,n,s[n]);return e},i=(e,t)=>s(e,n(t)),l=(e,s,n)=>new Promise((t,m)=>{var r=e=>{try{o(n.next(e))}catch(s){m(s)}},a=e=>{try{o(n.throw(e))}catch(s){m(s)}},o=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,a);o((n=n.apply(e,s)).next())});import{r as c,d as u,j as d,U as g,f as h,l as N,G as x,D as p,X as b,P as y,k as f,B as v,h as w,s as k,I as E,O as j,T as _,J as D}from"./react-core-CmOG7fiH.js";import{u as U,s as M,i as V}from"./index-DwXfnZku.js";import{t as R}from"./ui-BpXc_XmY.js";import{C as q}from"./CollapsibleSection-CtE4fUOM.js";import"./vendor-Dj0T90Ik.js";import"./supabase-k270UWii.js";function $(){var e,s,n,t,m,r,a,$,S,C,P,O,L,I,T,z,G,A,B,F,J,H;const[K,Q]=c.useState([]),[W,X]=c.useState([]),[Y,Z]=c.useState([]),[ee,se]=c.useState([]),[ne,te]=c.useState(!1),[me,re]=c.useState(!0),[ae,oe]=c.useState(""),[ie,le]=c.useState(!1),[ce,ue]=c.useState(null),[de,ge]=c.useState({phone:"",id_card:"",name:"",company_id:"",role_id:"",production_line:"",is_active:!1}),[he,Ne]=c.useState(!1),[xe,pe]=c.useState(!1),[be,ye]=c.useState(null),[fe,ve]=c.useState(!1),[we,ke]=c.useState({user:null,oldRole:null,newRole:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),[Ee,je]=c.useState(""),[_e,De]=c.useState(!1),[Ue,Me]=c.useState({user:null,oldProductionLine:"",newProductionLine:"",role:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),[Ve,Re]=c.useState(""),[qe,$e]=c.useState(""),{user:Se,loading:Ce}=U(),Pe=u();if(c.useEffect(()=>{if(!Ce&&!Se)return console.log("用户未登录，重定向到登录页面"),void Pe("/login")},[Se,Ce,Pe]),Ce)return d.jsxDEV("div",{className:"min-h-screen bg-black flex items-center justify-center",children:d.jsxDEV("div",{className:"text-center",children:[d.jsxDEV("div",{className:"text-green-400 text-2xl font-mono mb-4",children:"加载中..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:102,columnNumber:11},this),d.jsxDEV("div",{className:"text-green-600 font-mono",children:"正在验证用户身份"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:103,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:101,columnNumber:9},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:100,columnNumber:7},this);c.useEffect(()=>{Oe()},[]);const Oe=()=>l(this,null,function*(){var e,s,n;try{if(!Se)return console.error("fetchData: 用户信息不存在"),void R.error("用户信息不存在");let t=M.from("users").select("\n          *,\n          company:companies(name),\n          role:user_roles(name, permissions)\n        ");if(V(Se.role))console.log("fetchData: 超级管理员，不添加公司过滤");else{if(!(null==(e=Se.company)?void 0:e.id))return console.error("fetchData: 用户没有关联的公司ID"),void R.error("用户没有关联的公司，请联系管理员");t=t.eq("company_id",Se.company.id),console.log("fetchData: 添加公司过滤条件",Se.company.id)}const{data:m,error:r}=yield t.order("created_at",{ascending:!1});if(r)throw r;let a=M.from("companies").select("*");V(Se.role)||(a=a.eq("id",null==(s=Se.company)?void 0:s.id));const{data:l,error:c}=yield a.order("name");if(c)throw c;const{data:u,error:d}=yield M.from("user_roles").select("*").order("name");if(d)throw d;Q(m||[]),X(l||[]),Z(u||[]),!V(Se.role)&&(null==(n=Se.company)?void 0:n.id)&&ge(e=>i(o({},e),{company_id:Se.company.id}))}catch(t){console.error("获取数据失败:",t),$e("获取数据失败")}finally{re(!1)}}),Le=e=>l(this,null,function*(){var s,n;console.log("handleDelete 函数被调用，用户数据:",e),console.log("当前登录用户:",Se),console.log("用户角色:",null==Se?void 0:Se.role);try{if(V(Se.role))console.log("超级管理员，跳过公司权限检查");else{if(console.log("非超级管理员，检查公司权限"),e.company_id!==(null==(s=Se.company)?void 0:s.id))return console.log("权限检查失败：用户公司ID不匹配",e.company_id,null==(n=Se.company)?void 0:n.id),void R.error("您只能删除自己公司的用户");console.log("权限检查通过")}const m=Y.find(s=>s.id===e.role_id);if(console.log("用户角色信息:",m),m&&"超级管理员"===m.name)return console.log("阻止删除超级管理员"),void R.error("超级管理员角色不能被删除，这是系统保护机制");if(m&&("班长"===m.name||"段长"===m.name))try{console.log("检查班长/段长的待审核数据");let s=M.from("timesheet_records").select("id, user_id, status");"班长"===m.name?s=s.eq("supervisor_id",e.id):"段长"===m.name&&(s=s.eq("section_chief_id",e.id));const{data:n,error:t}=yield s;if(console.log("所有相关工时记录:",n,"错误:",t),n&&n.length>0){const e=n.reduce((e,s)=>(e[s.status]=(e[s.status]||0)+1,e),{});console.log("状态统计:",e)}let r=M.from("timesheet_records").select("id, user_id, status");if("班长"===m.name)r=r.in("status",["pending","待审核","submitted","已提交"]).eq("supervisor_id",e.id);else if("段长"===m.name){console.log("=== 段长删除调试开始 ==="),console.log("段长用户信息:",{id:e.id,name:e.name,production_line:e.production_line});const{data:s,error:n}=yield M.from("timesheet_records").select("id, user_id, status, section_chief_id, supervisor_id, work_date, created_at").eq("section_chief_id",e.id);if(console.log("该段长的所有相关记录:",s),console.log("查询所有记录的错误:",n),s){console.log("记录总数:",s.length);const e=s.reduce((e,s)=>(e[s.status]=(e[s.status]||0)+1,e),{});console.log("各状态记录数量:",e),s.forEach(e=>{console.log(`记录 ${e.id}: status=${e.status}, section_chief_id=${e.section_chief_id}, user_id=${e.user_id}, work_date=${e.work_date}`)})}console.log("执行段长待审核记录查询，条件: status=approved, section_chief_id=",e.id),r=r.eq("status","approved").eq("section_chief_id",e.id)}const{data:a,error:l}=yield r;if(console.log("待审核数据查询结果:",a,"错误:",l),console.log("查询条件 - 角色:",m.name,"用户ID:",e.id),"段长"===m.name&&(console.log("=== 段长待审核查询结果分析 ==="),console.log("查询到的待审核记录数量:",(null==a?void 0:a.length)||0),a&&a.length>0?(console.log("待审核记录详情:"),a.forEach(e=>{console.log(`  记录 ${e.id}: status=${e.status}, user_id=${e.user_id}`)})):console.log("没有查询到待审核记录"),console.log("=== 段长删除调试结束 ===")),l)return console.error("检查待审核数据失败:",l),void R.error("检查待审核数据失败，请稍后重试");if(a&&a.length>0){console.log("发现待审核数据，开始处理...","数量:",a.length),console.log("待审核记录详情:",a.map(e=>({id:e.id,status:e.status,user_id:e.user_id})));const{data:s,error:n}=yield M.from("timesheet_records").select("\n              id, user_id, status, work_date, created_at, updated_at,\n              user:users!user_id(id, name, is_active)\n            ").in("id",a.map(e=>e.id));console.log("待审核记录详细信息:",s),n&&console.error("查询记录详情失败:",n);const t=(null==s?void 0:s.filter(e=>{const s=e.user,n=null==s?void 0:s.is_active,t=e.work_date&&new Date(e.work_date)<=new Date;return console.log(`记录 ${e.id}: 用户激活=${n}, 有效日期=${t}, 用户=${null==s?void 0:s.name}`),n&&t}))||[];if(console.log("有效的待审核记录数量:",t.length),console.log("有效记录详情:",t),0!==t.length){const s=t,n=[...new Set(s.map(e=>e.user_id))];console.log("涉及的用户ID:",n);const{data:r}=yield M.from("users").select("name").in("id",n),a=r?r.map(e=>e.name):[];console.log("涉及的用户名称:",a),console.log("查找同生产线同角色用户，参数:",{company_id:e.company_id,production_line:e.production_line,role_id:e.role_id,exclude_user_id:e.id});const{data:l,error:c}=yield M.from("users").select("id, name, phone").eq("company_id",e.company_id).eq("production_line",e.production_line).eq("role_id",e.role_id).eq("is_active",!0).neq("id",e.id);if(console.log("同角色用户查询结果:",l,"错误:",c),c)return console.error("查找同角色用户失败:",c),void R.error("查找接收人失败，请稍后重试");if(!l||0===l.length){console.log("没有找到合适的接收人，显示错误提示"),console.log("🚨 ERROR: 没有找到合适的接收人 - 用户删除");const e=`无法删除${m.name}：还有${s.length}条待审核的工时记录需要处理，但该生产线没有其他激活的${m.name}可以接收这些数据。涉及员工：${a.join("、")}。请先在该生产线添加其他${m.name}或手动处理这些待审核数据。`;return console.log("🚨 ERROR MESSAGE:",e),R.error(e),void console.log("🚨 Toast.error 已调用")}return console.log("找到接收人，准备设置删除确认对话框"),ye(i(o({},e),{role:m,pendingRecords:s,sameRoleUsers:l,userNames:a})),console.log("设置userToDelete完成，准备显示删除确认对话框"),pe(!0),void console.log("删除确认对话框应该已显示")}{console.log("所有待审核记录都无效，继续删除流程");const e=a.filter(e=>!t.find(s=>s.id===e.id)).map(e=>e.id);e.length>0&&console.warn("发现无效的待审核记录，建议清理:",e)}}else console.log("没有发现待审核数据，继续删除流程")}catch(t){return console.error("检查待审核数据时出错:",t),void R.error("检查待审核数据时出错，请稍后重试")}console.log("班长/段长没有待审核数据，直接显示删除确认对话框"),console.log("显示删除确认对话框"),ye(i(o({},e),{role:m})),console.log("设置userToDelete完成"),pe(!0),console.log("删除确认对话框应该已显示")}catch(t){console.error("handleDelete函数执行失败:",t),R.error("操作失败："+(t.message||"未知错误"))}console.log("handleDelete函数执行完成")}),[Ie,Te]=c.useState(""),ze=e=>l(this,null,function*(){var s;const n=!e.is_active;try{if(!V(Se.role)&&e.company_id!==(null==(s=Se.company)?void 0:s.id))return void R.error("您只能修改自己公司用户的状态");console.log("正在切换用户状态:",e.id,e.name,"从",e.is_active,"到",n);const{data:t,error:m}=yield M.from("users").update({is_active:n,updated_at:(new Date).toISOString()}).eq("id",e.id).select("*");if(console.log("状态切换操作详情:",{data:t,error:m,userId:e.id,newStatus:n}),m)throw console.error("更新用户状态失败:",m),m;if(!t||0===t.length)throw console.error("状态更新操作没有返回数据，这通常表示权限问题或记录不存在"),new Error("状态更新失败：无法获取更新后的数据，请检查权限设置");console.log("状态切换成功:",e.name,"新状态:",n),R.success("用户状态更新成功"),yield Oe()}catch(t){console.error("更新用户状态失败:",t),$e(t.message||"更新状态失败"),R.error("更新用户状态失败")}}),Ge=e=>l(this,null,function*(){try{const{data:s,error:n}=yield M.from("processes").select("production_line").eq("company_id",e).not("production_line","is",null);if(n)throw n;const t=[...new Set((null==s?void 0:s.map(e=>e.production_line).filter(Boolean))||[])];se(t)}catch(s){console.error("获取生产线数据失败:",s),se([])}}),Ae=()=>{var e;const s={phone:"",id_card:"",name:"",company_id:"",role_id:"",production_line:"",is_active:!1};!V(Se.role)&&(null==(e=Se.company)?void 0:e.id)&&(s.company_id=Se.company.id),ge(s),ue(null),le(!1),te(!1),se([]),$e("")},Be=e=>{const{name:s,value:n}=e.target;if(ge(i(o({},de),{[s]:n})),"role_id"===s){const e=Y.find(e=>e.id===n),s="班长"===(null==e?void 0:e.name)||"段长"===(null==e?void 0:e.name);te(s),s&&de.company_id?Ge(de.company_id):(se([]),ge(e=>i(o({},e),{production_line:""})))}"company_id"===s&&(ne&&n?Ge(n):se([]),ge(e=>i(o({},e),{production_line:""})))},Fe=K.filter(e=>{var s;return e.name.toLowerCase().includes(ae.toLowerCase())||e.phone.includes(ae)||e.id_card.includes(ae)||(null==(s=e.company)?void 0:s.name)&&e.company.name.toLowerCase().includes(ae.toLowerCase())}),Je=Fe.reduce((e,s)=>{var n;const t=(null==(n=s.company)?void 0:n.name)||"未分配公司";return e[t]||(e[t]=[]),e[t].push(s),e},{}),He=Object.keys(Je).sort();return me?d.jsxDEV("div",{className:"min-h-screen bg-black flex items-center justify-center",children:d.jsxDEV("div",{className:"text-green-400 text-xl animate-pulse font-mono",children:"加载中..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1290,columnNumber:9},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1289,columnNumber:7},this):d.jsxDEV("div",{className:"min-h-screen bg-black text-green-300 p-6",children:d.jsxDEV("div",{className:"max-w-7xl mx-auto",children:[d.jsxDEV("div",{className:"mb-8",children:[d.jsxDEV("div",{className:"flex justify-between items-center mb-4",children:[d.jsxDEV("div",{className:"flex items-center",children:[d.jsxDEV(g,{className:"w-8 h-8 text-green-400 mr-3"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1304,columnNumber:15},this),d.jsxDEV("h1",{className:"text-4xl font-bold text-green-400 font-mono",children:"用户管理"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1305,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1303,columnNumber:13},this),d.jsxDEV(h,{to:"/dashboard",className:"flex items-center gap-2 px-3 py-2 sm:px-4 sm:py-2 bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-600 hover:to-gray-700 text-green-300 hover:text-green-200 rounded-lg font-mono transition-all duration-200 shadow-md hover:shadow-lg border border-gray-600 hover:border-green-500/50",children:[d.jsxDEV(N,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1311,columnNumber:15},this),d.jsxDEV("span",{className:"hidden sm:inline",children:"返回控制台"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1312,columnNumber:15},this),d.jsxDEV("span",{className:"sm:hidden",children:"返回"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1313,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1307,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1302,columnNumber:11},this),d.jsxDEV("div",{className:"h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1316,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1301,columnNumber:9},this),qe&&d.jsxDEV("div",{className:"mb-6 p-4 bg-red-900/50 border border-red-400 rounded text-red-300",children:qe},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1320,columnNumber:11},this),d.jsxDEV("div",{className:"mb-6 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center",children:[d.jsxDEV("div",{className:"relative flex-1 max-w-md",children:[d.jsxDEV(x,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1329,columnNumber:13},this),d.jsxDEV("input",{type:"text",value:ae,onChange:e=>oe(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-gray-900 border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"搜索用户姓名、手机号、身份证号或公司..."},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1330,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1328,columnNumber:11},this),d.jsxDEV("button",{onClick:()=>{Ae(),le(!0)},className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 text-black font-bold rounded transition-colors font-mono",children:[d.jsxDEV(p,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1347,columnNumber:13},this),"新增用户"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1340,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1326,columnNumber:9},this),ie&&d.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:d.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[d.jsxDEV("div",{className:"flex justify-between items-center mb-6",children:[d.jsxDEV("h2",{className:"text-2xl font-bold text-green-400 font-mono",children:ce?"编辑用户":"新增用户"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1357,columnNumber:17},this),d.jsxDEV("button",{onClick:Ae,className:"text-green-400 hover:text-green-300",children:d.jsxDEV(b,{className:"w-6 h-6"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1364,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1360,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1356,columnNumber:15},this),d.jsxDEV("form",{onSubmit:e=>l(this,null,function*(){var s,n;e.preventDefault(),Ne(!0),$e("");try{if(!V(Se.role)){if(de.company_id!==(null==(s=Se.company)?void 0:s.id))return R.error("您只能操作自己公司的用户"),void Ne(!1);if(ce&&ce.company_id!==(null==(n=Se.company)?void 0:n.id))return R.error("您只能编辑自己公司的用户"),void Ne(!1)}if(ce){const e=Y.find(e=>e.id===ce.role_id),s=Y.find(e=>e.id===de.role_id),n=ce.production_line!==de.production_line;if(("班长"===(null==e?void 0:e.name)||"段长"===(null==e?void 0:e.name))&&e.id!==(null==s?void 0:s.id)){console.log("检测到班长/段长角色修改，检查待审核数据...");let n=M.from("timesheet_records").select("id, user_id, status").in("status",["pending","待审核","submitted","已提交"]);"班长"===e.name?n=n.eq("supervisor_id",ce.id):"段长"===e.name&&(n=n.eq("section_chief_id",ce.id));const{data:t,error:m}=yield n;if(m)throw console.error("检查待审核数据失败:",m),new Error("检查待审核数据失败，请稍后重试");if(t&&t.length>0){const{data:n}=yield M.from("timesheet_records").select("\n                id, user_id, status, work_date,\n                user:users!user_id(id, name, is_active)\n              ").in("id",t.map(e=>e.id)),m=(null==n?void 0:n.filter(e=>{const s=e.user,n=null==s?void 0:s.is_active,t=e.work_date&&new Date(e.work_date)<=new Date;return n&&t}))||[];if(m.length>0){const{data:n}=yield M.from("users").select("id, name, phone").eq("company_id",ce.company_id).eq("production_line",ce.production_line).eq("role_id",ce.role_id).eq("is_active",!0).neq("id",ce.id);if(!n||0===n.length){const s=[...new Set(m.map(e=>{var s;return null==(s=e.user)?void 0:s.name}))].join("、");console.log("角色修改 - 没有找到接收人，显示错误提示"),console.log("🚨 ERROR: 没有找到合适的接收人 - 角色修改");const n=`无法修改${e.name}角色：还有${m.length}条待审核的工时记录需要处理，但该生产线没有其他激活的${e.name}可以接收这些数据。涉及员工：${s}。请先在该生产线添加其他${e.name}或手动处理这些待审核数据。`;return console.log("🚨 ERROR MESSAGE:",n),R.error(n),console.log("🚨 Toast.error 已调用"),void Ne(!1)}const t=[...new Set(m.map(e=>{var s;return null==(s=e.user)?void 0:s.name}))];return ke({user:ce,oldRole:e,newRole:s,pendingRecords:m,sameRoleUsers:n||[],userNames:t}),ve(!0),void Ne(!1)}}}if(("班长"===(null==e?void 0:e.name)||"段长"===(null==e?void 0:e.name))&&n){console.log("检测到班长/段长生产线变更，检查待审核数据..."),console.log("生产线变更详情:",{oldProductionLine:ce.production_line,newProductionLine:de.production_line,role:e.name,userId:ce.id});let s=M.from("timesheet_records").select("id, user_id, status");"班长"===e.name?s=s.eq("supervisor_id",ce.id).in("status",["pending","待审核","submitted","已提交"]):"段长"===e.name&&(s=s.eq("section_chief_id",ce.id).in("status",["approved"])),console.log("生产线变更 - 待审核数据查询条件:",{role:e.name,userId:ce.id,statusFilter:"班长"===e.name?["pending","待审核","submitted","已提交"]:["approved"]});const{data:n,error:t}=yield s;if(console.log("生产线变更 - 待审核数据查询结果:",{pendingRecords:n,pendingError:t}),t)throw console.error("检查待审核数据失败:",t),new Error("检查待审核数据失败，请稍后重试");if(n&&n.length>0){console.log("生产线变更 - 找到待审核记录，查询详细信息...");const{data:s}=yield M.from("timesheet_records").select("\n                id, user_id, status, work_date,\n                user:users!user_id(id, name, is_active)\n              ").in("id",n.map(e=>e.id));console.log("生产线变更 - 详细记录查询结果:",s);const t=(null==s?void 0:s.filter(e=>{const s=e.user,n=null==s?void 0:s.is_active,t=e.work_date&&new Date(e.work_date)<=new Date;return console.log(`生产线变更 - 记录 ${e.id}: 用户激活=${n}, 有效日期=${t}`),n&&t}))||[];if(console.log("生产线变更 - 有效记录数量:",t.length),t.length>0){console.log("生产线变更 - 查找原生产线接收人...");const{data:s,error:n}=yield M.from("users").select("id, name, phone").eq("company_id",ce.company_id).eq("production_line",ce.production_line).eq("role_id",ce.role_id).eq("is_active",!0).neq("id",ce.id);if(console.log("生产线变更 - 接收人查询结果:",{sameRoleUsers:s,sameRoleError:n}),console.log("生产线变更 - 查询条件:",{company_id:ce.company_id,production_line:ce.production_line,role_id:ce.role_id,exclude_user_id:ce.id}),!s||0===s.length){const s=[...new Set(t.map(e=>{var s;return null==(s=e.user)?void 0:s.name}))].join("、");console.log("生产线变更 - 没有找到接收人，显示错误提示"),console.log("🚨 ERROR: 没有找到合适的接收人 - 生产线变更");const n=`无法更换生产线：还有${t.length}条待审核的工时记录需要处理，但原生产线(${ce.production_line})没有其他激活的${e.name}可以接收这些数据。涉及员工：${s}。请先在原生产线添加其他${e.name}或手动处理这些待审核数据。`;return console.log("🚨 ERROR MESSAGE:",n),R.error(n),console.log("🚨 Toast.error 已调用"),void Ne(!1)}console.log("生产线变更 - 找到接收人，设置确认对话框");const m=[...new Set(t.map(e=>{var s;return null==(s=e.user)?void 0:s.name}))];return Me({user:ce,oldProductionLine:ce.production_line,newProductionLine:de.production_line,role:e,pendingRecords:t,sameRoleUsers:s||[],userNames:m}),De(!0),Ne(!1),void console.log("生产线变更 - 确认对话框已设置，函数返回")}console.log("生产线变更 - 没有有效的待审核记录，继续更新用户")}else console.log("生产线变更 - 没有找到待审核记录，继续更新用户")}console.log("正在更新用户:",ce.id,"新数据:",de);const{data:t,error:m}=yield M.from("users").update({phone:de.phone,id_card:de.id_card,name:de.name,company_id:de.company_id,role_id:de.role_id,production_line:de.production_line||null,is_active:de.is_active,updated_at:(new Date).toISOString()}).eq("id",ce.id).select("*");if(console.log("更新操作详情:",{data:t,error:m,formData:de,userId:ce.id}),m)throw console.error("更新用户失败:",m),m;if(!t||0===t.length)throw console.error("更新操作没有返回数据，这通常表示权限问题或记录不存在"),new Error("更新失败：无法获取更新后的数据，请检查权限设置");console.log("更新成功，返回数据:",t)}else{const{data:e}=yield M.from("users").select("id").or(`phone.eq.${de.phone},id_card.eq.${de.id_card}`).single();if(e)throw new Error("手机号或身份证号已存在");const s="123456",{data:n,error:t}=yield M.from("users").insert([{phone:de.phone,password_hash:s,id_card:de.id_card,name:de.name,company_id:de.company_id,role_id:de.role_id,production_line:de.production_line||null,is_active:de.is_active}]).select("*");if(t)throw console.error("创建用户失败:",t),t;if(!n||0===n.length)throw console.error("创建操作没有返回数据，这通常表示权限问题"),new Error("创建失败：无法获取创建后的数据，请检查权限设置");console.log("创建成功，返回数据:",n)}const e=ce?"用户信息更新成功！":"用户创建成功！";console.log(e),console.log("重新获取用户列表..."),yield Oe(),Ae(),console.log("操作完成，表单已重置")}catch(t){console.error("保存用户信息失败:",t),$e(t.message||"保存失败")}finally{Ne(!1)}}),className:"space-y-4",children:[d.jsxDEV("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"姓名 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1371,columnNumber:21},this),d.jsxDEV("div",{className:"relative",children:[d.jsxDEV(g,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1375,columnNumber:23},this),d.jsxDEV("input",{type:"text",name:"name",value:de.name,onChange:Be,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入姓名"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1376,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1374,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1370,columnNumber:19},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"手机号 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1389,columnNumber:21},this),d.jsxDEV("div",{className:"relative",children:[d.jsxDEV(y,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1393,columnNumber:23},this),d.jsxDEV("input",{type:"tel",name:"phone",value:de.phone,onChange:Be,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入手机号",maxLength:11},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1394,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1392,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1388,columnNumber:19},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"身份证号 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1408,columnNumber:21},this),d.jsxDEV("div",{className:"relative",children:[d.jsxDEV(f,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1412,columnNumber:23},this),d.jsxDEV("input",{type:"text",name:"id_card",value:de.id_card,onChange:Be,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 placeholder-green-600 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",placeholder:"请输入身份证号",maxLength:18},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1413,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1411,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1407,columnNumber:19},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"所属公司 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1429,columnNumber:21},this),d.jsxDEV("div",{className:"relative",children:[d.jsxDEV(v,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1433,columnNumber:23},this),V(Se.role)&&!ce?d.jsxDEV("select",{name:"company_id",value:de.company_id,onChange:Be,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",children:[d.jsxDEV("option",{value:"",children:"请选择公司"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1442,columnNumber:27},this),W.map(e=>d.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1444,columnNumber:29},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1435,columnNumber:25},this):d.jsxDEV("div",{className:"w-full pl-10 pr-4 py-2 bg-gray-800 border border-green-400 rounded text-green-300 font-mono text-sm",children:[(null==(e=W.find(e=>e.id===de.company_id))?void 0:e.name)||(null==(s=Se.company)?void 0:s.name)||"当前公司",ce&&d.jsxDEV("span",{className:"ml-2 text-yellow-400 text-xs",children:"(编辑时不可修改)"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1453,columnNumber:29},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1450,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1432,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1428,columnNumber:19},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"用户角色 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1461,columnNumber:21},this),d.jsxDEV("div",{className:"relative",children:[d.jsxDEV(w,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1465,columnNumber:23},this),d.jsxDEV("select",{name:"role_id",value:de.role_id,onChange:Be,required:!0,className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",children:[d.jsxDEV("option",{value:"",children:"请选择角色"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1473,columnNumber:25},this),Y.map(e=>d.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1475,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1466,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1464,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1460,columnNumber:19},this),ne&&d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"生产线 *"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1486,columnNumber:23},this),d.jsxDEV("select",{name:"production_line",value:de.production_line||"",onChange:Be,className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[d.jsxDEV("option",{value:"",children:"请选择生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1496,columnNumber:25},this),ee.map(e=>d.jsxDEV("option",{value:e,children:e},e,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1498,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1489,columnNumber:23},this),0===ee.length&&de.company_id&&d.jsxDEV("div",{className:"mt-1 text-yellow-400 text-xs font-mono",children:"该公司暂无可用生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1504,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1485,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1369,columnNumber:17},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-1",children:"用户状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1513,columnNumber:19},this),d.jsxDEV("div",{className:"relative",children:[d.jsxDEV(k,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400 w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1517,columnNumber:21},this),d.jsxDEV("select",{name:"is_active",value:de.is_active.toString(),onChange:e=>ge(i(o({},de),{is_active:"true"===e.target.value})),className:"w-full pl-10 pr-4 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",children:[d.jsxDEV("option",{value:"true",children:"激活"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1524,columnNumber:23},this),d.jsxDEV("option",{value:"false",children:"禁用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1525,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1518,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1516,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1512,columnNumber:17},this),d.jsxDEV("div",{className:"flex gap-3 pt-4",children:[d.jsxDEV("button",{type:"submit",disabled:he,className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 disabled:bg-green-800 text-black font-bold rounded transition-colors font-mono",children:[d.jsxDEV(E,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1536,columnNumber:21},this),he?"保存中...":"保存"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1531,columnNumber:19},this),d.jsxDEV("button",{type:"button",onClick:Ae,className:"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1539,columnNumber:19},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1530,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1368,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1355,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1354,columnNumber:11},this),He.length>0?d.jsxDEV("div",{className:"space-y-6",children:He.map(e=>{const s=Je[e];return d.jsxDEV(q,{title:d.jsxDEV("div",{className:"flex items-center justify-between w-full",children:[d.jsxDEV("div",{className:"flex items-center gap-2",children:[d.jsxDEV(v,{className:"w-5 h-5"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1563,columnNumber:25},this),e]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1562,columnNumber:23},this),d.jsxDEV("span",{className:"text-sm font-mono text-green-400 bg-green-900/30 px-2 py-1 rounded",children:[s.length," 名用户"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1566,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1561,columnNumber:21},this),defaultExpanded:!0,className:"bg-gray-900 border border-green-400 rounded-lg overflow-hidden",children:d.jsxDEV("div",{className:"overflow-x-auto",children:d.jsxDEV("table",{className:"w-full",children:[d.jsxDEV("thead",{className:"bg-green-900/30",children:d.jsxDEV("tr",{children:[d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"序号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1580,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"姓名"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1581,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"手机号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1582,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"身份证号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1583,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"角色"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1584,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1585,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1586,columnNumber:27},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"操作"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1587,columnNumber:27},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1579,columnNumber:25},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1578,columnNumber:23},this),d.jsxDEV("tbody",{className:"divide-y divide-green-800",children:s.map((e,s)=>{var n;return d.jsxDEV("tr",{className:"hover:bg-green-900/10",children:[d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("span",{className:"text-sm font-mono font-medium text-green-300",children:s+1},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1594,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1593,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("div",{className:"flex items-center",children:[d.jsxDEV(g,{className:"w-4 h-4 text-green-400 mr-2"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1600,columnNumber:33},this),d.jsxDEV("span",{className:"text-sm font-mono font-medium text-green-300",children:e.name},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1601,columnNumber:33},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1599,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1598,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:e.phone},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1607,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1606,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:e.id_card},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1612,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1611,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:(null==(n=e.role)?void 0:n.name)||"未分配"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1617,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1616,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("span",{className:"text-sm font-mono text-green-300",children:e.production_line||"-"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1622,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1621,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap",children:d.jsxDEV("button",{onClick:()=>ze(e),className:"inline-flex px-2 py-1 text-xs font-mono font-semibold rounded-full "+(e.is_active?"bg-green-900/50 text-green-300 border border-green-400":"bg-red-900/50 text-red-300 border border-red-400"),children:e.is_active?"激活":"禁用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1627,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1626,columnNumber:29},this),d.jsxDEV("td",{className:"px-4 py-3 whitespace-nowrap text-sm font-medium",children:d.jsxDEV("div",{className:"flex gap-2",children:[d.jsxDEV("button",{onClick:()=>(e=>{var s;if(!V(Se.role)&&e.company_id!==(null==(s=Se.company)?void 0:s.id))return void R.error("您只能编辑自己公司的用户");ue(e),ge({phone:e.phone,id_card:e.id_card,name:e.name,company_id:e.company_id,role_id:e.role_id,production_line:e.production_line||"",is_active:e.is_active});const n=Y.find(s=>s.id===e.role_id),t="班长"===(null==n?void 0:n.name)||"段长"===(null==n?void 0:n.name);te(t),t&&e.company_id&&Ge(e.company_id),le(!0)})(e),className:"text-green-400 hover:text-green-300 transition-colors",title:"编辑",children:d.jsxDEV(j,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1645,columnNumber:35},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1640,columnNumber:33},this),d.jsxDEV("button",{onClick:()=>Le(e),className:"text-red-400 hover:text-red-300 transition-colors",title:"删除",children:d.jsxDEV(_,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1652,columnNumber:35},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1647,columnNumber:33},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1639,columnNumber:31},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1638,columnNumber:29},this)]},e.id,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1592,columnNumber:27},this)})},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1590,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1577,columnNumber:21},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1576,columnNumber:19},this)},e,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1558,columnNumber:17},this)})},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1554,columnNumber:11},this):d.jsxDEV("div",{className:"bg-gray-900 border border-green-400 rounded-lg overflow-hidden",children:d.jsxDEV("div",{className:"overflow-x-auto",children:d.jsxDEV("table",{className:"w-full",children:[d.jsxDEV("thead",{className:"bg-green-900/30",children:d.jsxDEV("tr",{children:[d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"序号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1671,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"姓名"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1672,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"手机号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1673,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"身份证号"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1674,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"公司"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1675,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"角色"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1676,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"生产线"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1677,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1678,columnNumber:21},this),d.jsxDEV("th",{className:"px-4 py-3 text-left text-sm font-mono font-medium text-green-400 uppercase tracking-wider",children:"操作"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1679,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1670,columnNumber:19},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1669,columnNumber:17},this),d.jsxDEV("tbody",{className:"divide-y divide-green-800"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1682,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1668,columnNumber:15},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1667,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1666,columnNumber:11},this),0===Fe.length&&d.jsxDEV("div",{className:"text-center py-12",children:[d.jsxDEV(g,{className:"w-16 h-16 text-green-600 mx-auto mb-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1692,columnNumber:13},this),d.jsxDEV("p",{className:"text-green-400 text-lg font-mono",children:ae?"未找到匹配的用户":"暂无用户数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1693,columnNumber:13},this),d.jsxDEV("p",{className:"text-green-600 text-sm font-mono mt-2",children:ae?"请尝试其他搜索关键词":"点击上方按钮添加第一个用户"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1696,columnNumber:13},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1691,columnNumber:11},this),fe&&we&&d.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:d.jsxDEV("div",{className:"bg-gray-900 border border-yellow-400 rounded-lg p-6 w-full max-w-md",children:[d.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[d.jsxDEV(D,{className:"text-yellow-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1707,columnNumber:17},this),d.jsxDEV("h2",{className:"text-xl font-bold text-yellow-400 font-mono",children:"确认角色修改"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1708,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1706,columnNumber:15},this),d.jsxDEV("div",{className:"mb-6",children:[d.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:["确定要将用户 ",d.jsxDEV("span",{className:"text-green-400 font-bold",children:['"',we.user.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1715,columnNumber:26},this)," 的角色从",d.jsxDEV("span",{className:"text-blue-400 font-bold",children:['"',we.oldRole.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1716,columnNumber:19},this)," 修改为",d.jsxDEV("span",{className:"text-purple-400 font-bold",children:['"',we.newRole.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1717,columnNumber:19},this)," 吗？"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1714,columnNumber:17},this),we.pendingRecords&&we.pendingRecords.length>0?d.jsxDEV("div",{className:"space-y-3",children:[d.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"⚠️ 数据转移："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1723,columnNumber:23},this),d.jsxDEV("p",{className:"text-xs mb-2",children:["检测到",we.pendingRecords.length,"条待审核工时记录需要转移。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1724,columnNumber:23},this),d.jsxDEV("p",{className:"text-yellow-200 text-xs",children:["涉及员工：",null==(n=we.userNames)?void 0:n.join("、")]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1725,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1722,columnNumber:21},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-2",children:"选择数据接收人："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1730,columnNumber:23},this),d.jsxDEV("select",{value:Ee,onChange:e=>je(e.target.value),className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[d.jsxDEV("option",{value:"",children:"请选择接收人"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1739,columnNumber:25},this),null==(t=we.sameRoleUsers)?void 0:t.map(e=>d.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1741,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1733,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1729,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1721,columnNumber:19},this):d.jsxDEV("div",{className:"text-green-300 font-mono text-sm mb-2 p-3 bg-green-900/20 border border-green-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"✅ 安全修改："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1750,columnNumber:21},this),d.jsxDEV("p",{className:"text-xs",children:["该",we.oldRole.name,"没有待审核的工时记录，可以安全修改角色。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1751,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1749,columnNumber:19},this),d.jsxDEV("p",{className:"text-yellow-300 font-mono text-sm mt-2",children:"角色修改后将影响用户的权限和功能访问。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1755,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1713,columnNumber:15},this),d.jsxDEV("div",{className:"flex gap-3",children:[d.jsxDEV("button",{onClick:()=>l(this,null,function*(){var e,s;if(we.user&&Ee)try{console.log("执行角色修改数据转移...");const n="班长"===(null==(e=we.oldRole)?void 0:e.name)?"supervisor_id":"section_chief_id",{error:t}=yield M.from("timesheet_records").update({[n]:Ee}).in("id",we.pendingRecords.map(e=>e.id));if(t)throw console.error("数据转移失败:",t),new Error("数据转移失败，请稍后重试");const{error:m}=yield M.from("users").update({phone:de.phone,id_card:de.id_card,name:de.name,company_id:de.company_id,role_id:de.role_id,production_line:de.production_line||null,is_active:de.is_active,updated_at:(new Date).toISOString()}).eq("id",we.user.id);if(m)throw console.error("角色修改失败:",m),m;const r=null==(s=we.sameRoleUsers.find(e=>e.id===Ee))?void 0:s.name;R.success(`角色修改成功！已将${we.pendingRecords.length}条待审核数据转移给${r}`),ve(!1),ke({user:null,oldRole:null,newRole:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),je(""),Ae(),yield Oe()}catch(n){console.error("角色修改失败:",n),R.error(n.message||"角色修改失败")}else R.error("请选择数据接收人")}),disabled:(null==(m=we.pendingRecords)?void 0:m.length)>0&&!Ee,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-500 disabled:bg-yellow-800 disabled:cursor-not-allowed text-white font-bold rounded transition-colors font-mono",children:[d.jsxDEV(j,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1766,columnNumber:19},this),"确认修改"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1761,columnNumber:17},this),d.jsxDEV("button",{onClick:()=>{ve(!1),ke({user:null,oldRole:null,newRole:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),je(""),Ne(!1)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1769,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1760,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1705,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1704,columnNumber:11},this),xe&&be&&d.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:d.jsxDEV("div",{className:"bg-gray-900 border border-red-400 rounded-lg p-6 w-full max-w-md",children:[d.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[d.jsxDEV(D,{className:"text-red-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1785,columnNumber:17},this),d.jsxDEV("h2",{className:"text-xl font-bold text-red-400 font-mono",children:"确认删除"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1786,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1784,columnNumber:15},this),d.jsxDEV("div",{className:"mb-6",children:[d.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:["确定要删除用户 ",d.jsxDEV("span",{className:"text-green-400 font-bold",children:['"',be.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1793,columnNumber:27},this)," 吗？"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1792,columnNumber:17},this),"员工"===(null==(r=be.role)?void 0:r.name)?d.jsxDEV("div",{className:"text-blue-300 font-mono text-sm mb-2 p-3 bg-blue-900/20 border border-blue-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"ℹ️ 员工处理影响："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1799,columnNumber:21},this),d.jsxDEV("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[d.jsxDEV("li",{children:"保留历史工时记录和审批历史记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1801,columnNumber:23},this),d.jsxDEV("li",{children:"断开数据关联，账户设为非激活状态"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1802,columnNumber:23},this),d.jsxDEV("li",{children:"重新申请时不关联旧数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1803,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1800,columnNumber:21},this),d.jsxDEV("p",{className:"text-blue-200 text-xs mt-2",children:"员工处理对系统数据影响较小，数据完整性得到保护"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1805,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1798,columnNumber:19},this):"班长"===(null==(a=be.role)?void 0:a.name)||"段长"===(null==($=be.role)?void 0:$.name)?be.pendingRecords&&be.pendingRecords.length>0?d.jsxDEV("div",{className:"space-y-3",children:[d.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"⚠️ 数据转移："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1811,columnNumber:25},this),d.jsxDEV("p",{className:"text-xs mb-2",children:["检测到",be.pendingRecords.length,"条待审核工时记录需要转移。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1812,columnNumber:25},this),d.jsxDEV("p",{className:"text-yellow-200 text-xs",children:["涉及员工：",null==(S=be.userNames)?void 0:S.join("、")]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1813,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1810,columnNumber:23},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-2",children:"选择数据接收人："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1818,columnNumber:25},this),d.jsxDEV("select",{value:Ie,onChange:e=>Te(e.target.value),className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[d.jsxDEV("option",{value:"",children:"请选择接收人"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1827,columnNumber:27},this),null==(C=be.sameRoleUsers)?void 0:C.map(e=>d.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1829,columnNumber:29},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1821,columnNumber:25},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1817,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1809,columnNumber:21},this):d.jsxDEV("div",{className:"text-green-300 font-mono text-sm mb-2 p-3 bg-green-900/20 border border-green-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"✅ 安全删除："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1838,columnNumber:23},this),d.jsxDEV("p",{className:"text-xs",children:["该",null==(P=be.role)?void 0:P.name,"没有待审核的工时记录，可以安全删除。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1839,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1837,columnNumber:21},this):"生产经理"===(null==(O=be.role)?void 0:O.name)||"财务"===(null==(L=be.role)?void 0:L.name)?d.jsxDEV("div",{className:"text-purple-300 font-mono text-sm mb-2 p-3 bg-purple-900/20 border border-purple-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:["ℹ️ ",null==(I=be.role)?void 0:I.name,"删除影响："]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1844,columnNumber:21},this),d.jsxDEV("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[d.jsxDEV("li",{children:"直接删除用户账户，不影响工时数据"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1846,columnNumber:23},this),d.jsxDEV("li",{children:"清理相关的审批历史记录引用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1847,columnNumber:23},this),d.jsxDEV("li",{children:"不需要数据转移或特殊处理"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1848,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1845,columnNumber:21},this),d.jsxDEV("p",{className:"text-purple-200 text-xs mt-2",children:[null==(T=be.role)?void 0:T.name,"删除对工时管理系统影响较小"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1850,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1843,columnNumber:19},this):d.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm mb-2 p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"⚠️ 删除操作将会："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1854,columnNumber:21},this),d.jsxDEV("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[d.jsxDEV("li",{children:"清理该用户在工时记录中的相关引用"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1856,columnNumber:23},this),d.jsxDEV("li",{children:"删除该用户的审批历史记录"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1857,columnNumber:23},this),d.jsxDEV("li",{children:"永久删除用户账户信息"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1858,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1855,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1853,columnNumber:19},this),d.jsxDEV("p",{className:"text-red-300 font-mono text-sm mt-2",children:"此操作不可恢复，请谨慎操作。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1863,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1791,columnNumber:15},this),d.jsxDEV("div",{className:"flex gap-3",children:[d.jsxDEV("button",{onClick:()=>l(this,null,function*(){var e,s,n,t;if(be)try{console.log("正在删除用户:",be.id,be.name);const m=be.role;if(be.pendingRecords&&be.pendingRecords.length>0){if(!Ie)return void R.error("请选择数据接收人");console.log("执行数据转移...");const n="班长"===(null==m?void 0:m.name)?"supervisor_id":"section_chief_id",t="班长"===(null==m?void 0:m.name)?["pending","待审核","submitted","已提交"]:["approved"],{error:r}=yield M.from("timesheet_records").update({[n]:Ie}).eq(n,be.id).in("status",t);if(r)return console.error("数据转移失败:",r),void R.error("数据转移失败，请稍后重试");const a=null==(s=null==(e=be.sameRoleUsers)?void 0:e.find(e=>e.id===Ie))?void 0:s.name;console.log(`数据转移成功：${be.pendingRecords.length}条记录转移给${a}`)}if(console.log("开始事务性删除操作..."),"员工"===(null==m?void 0:m.name)){console.log("员工角色删除：保留历史数据但断开关联，彻底删除用户账户"),console.log("断开工时记录中的用户关联...");const{error:e}=yield M.from("timesheet_records").update({user_id:null}).eq("user_id",be.id);if(e)throw console.error("断开工时记录用户关联失败:",e),new Error("断开工时记录关联失败："+e.message);console.log("断开审批历史中的审核人关联...");const{error:s}=yield M.from("approval_history").update({approver_id:null}).eq("approver_id",be.id);if(s)throw console.error("断开审批历史审核人关联失败:",s),new Error("断开审批历史关联失败："+s.message);console.log("员工数据关联断开完成，准备删除用户账户")}else{console.log("非员工角色删除：清理外键引用"),console.log("清理工时记录中的外键引用...");const{error:e}=yield M.from("timesheet_records").update({supervisor_id:null}).eq("supervisor_id",be.id);if(e)throw console.error("清理supervisor_id引用失败:",e),new Error("清理工时记录引用失败："+e.message);const{error:s}=yield M.from("timesheet_records").update({section_chief_id:null}).eq("section_chief_id",be.id);if(s)throw console.error("清理section_chief_id引用失败:",s),new Error("清理工时记录引用失败："+s.message);const{error:n}=yield M.from("approval_history").update({approver_id:null}).eq("approver_id",be.id);if(n)throw console.error("清理审核历史引用失败:",n),new Error("清理审核历史引用失败："+n.message);console.log("外键引用清理完成")}console.log("更新历史记录中的姓名字段...");const{error:r}=yield M.rpc("update_user_names_before_delete",{user_id_to_delete:be.id});if(r)throw console.error("更新姓名字段失败:",r),new Error("更新历史记录姓名字段失败："+r.message);console.log("历史记录姓名字段更新完成"),console.log("执行硬删除用户...");const{data:a,error:o}=yield M.from("users").delete().eq("id",be.id).select("*");if(console.log("硬删除操作详情:",{data:a,error:o,userId:be.id}),o)throw console.error("硬删除用户失败:",o),o;if(console.log("硬删除成功:",be.name),be.pendingRecords&&be.pendingRecords.length>0){const e=null==(t=null==(n=be.sameRoleUsers)?void 0:n.find(e=>e.id===Ie))?void 0:t.name;R.success(`用户删除成功，已将${be.pendingRecords.length}条待审核工时记录转移给${e}，历史记录已保留姓名信息`)}else R.success(`${(null==m?void 0:m.name)||"用户"} ${be.name} 删除成功：用户账户已永久删除，历史记录已保留姓名信息`);pe(!1),ye(null),Te(""),yield Oe()}catch(m){console.error("删除用户失败:",m);let e="删除用户失败";m.message&&(e=m.message.includes("foreign key constraint")?"删除失败：该用户仍有关联的数据记录，请联系系统管理员":m.message.includes("permission denied")?"删除失败：权限不足，请检查您的操作权限":m.message.includes("清理工时记录引用失败")?"删除失败：清理工时记录关联数据时出错":m.message.includes("清理审核历史引用失败")?"删除失败：清理审核历史数据时出错":`删除失败：${m.message}`),$e(e),R.error(e),pe(!1),ye(null)}}),disabled:(null==(z=be.pendingRecords)?void 0:z.length)>0&&!Ie,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-500 disabled:bg-red-800 disabled:cursor-not-allowed text-white font-bold rounded transition-colors font-mono",children:[d.jsxDEV(_,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1874,columnNumber:19},this),"员工"===(null==(G=be.role)?void 0:G.name)?"确认处理":"确认删除"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1869,columnNumber:17},this),d.jsxDEV("button",{onClick:()=>{pe(!1),ye(null)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1877,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1868,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1783,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1782,columnNumber:11},this),_e&&Ue&&d.jsxDEV("div",{className:"fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50",children:d.jsxDEV("div",{className:"bg-gray-900 border border-blue-400 rounded-lg p-6 w-full max-w-md",children:[d.jsxDEV("div",{className:"flex items-center gap-3 mb-4",children:[d.jsxDEV(D,{className:"text-blue-400 w-8 h-8"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1893,columnNumber:17},this),d.jsxDEV("h2",{className:"text-xl font-bold text-blue-400 font-mono",children:"确认生产线变更"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1894,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1892,columnNumber:15},this),d.jsxDEV("div",{className:"mb-6",children:[d.jsxDEV("p",{className:"text-green-300 font-mono mb-2",children:["确定要将用户 ",d.jsxDEV("span",{className:"text-green-400 font-bold",children:['"',Ue.user.name,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1901,columnNumber:26},this)," 的生产线从",d.jsxDEV("span",{className:"text-blue-400 font-bold",children:['"',Ue.oldProductionLine,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1902,columnNumber:19},this)," 变更为",d.jsxDEV("span",{className:"text-purple-400 font-bold",children:['"',Ue.newProductionLine,'"']},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1903,columnNumber:19},this)," 吗？"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1900,columnNumber:17},this),Ue.pendingRecords&&Ue.pendingRecords.length>0?d.jsxDEV("div",{className:"space-y-3",children:[d.jsxDEV("div",{className:"text-yellow-300 font-mono text-sm p-3 bg-yellow-900/20 border border-yellow-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"⚠️ 数据转移："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1909,columnNumber:23},this),d.jsxDEV("p",{className:"text-xs mb-2",children:["检测到",Ue.pendingRecords.length,"条待审核工时记录需要转移到原生产线(",Ue.oldProductionLine,")的相同角色下。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1910,columnNumber:23},this),d.jsxDEV("p",{className:"text-yellow-200 text-xs",children:["涉及员工：",null==(A=Ue.userNames)?void 0:A.join("、")]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1911,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1908,columnNumber:21},this),d.jsxDEV("div",{children:[d.jsxDEV("label",{className:"block text-green-300 text-sm font-mono mb-2",children:["选择原生产线的",null==(B=Ue.role)?void 0:B.name,"作为数据接收人："]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1916,columnNumber:23},this),d.jsxDEV("select",{value:Ve,onChange:e=>Re(e.target.value),className:"w-full px-3 py-2 bg-black border border-green-400 rounded text-green-300 focus:outline-none focus:border-green-300 focus:ring-1 focus:ring-green-300 font-mono text-sm",required:!0,children:[d.jsxDEV("option",{value:"",children:"请选择接收人"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1925,columnNumber:25},this),null==(F=Ue.sameRoleUsers)?void 0:F.map(e=>d.jsxDEV("option",{value:e.id,children:e.name},e.id,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1927,columnNumber:27},this))]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1919,columnNumber:23},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1915,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1907,columnNumber:19},this):d.jsxDEV("div",{className:"text-green-300 font-mono text-sm mb-2 p-3 bg-green-900/20 border border-green-600 rounded",children:[d.jsxDEV("p",{className:"mb-1",children:"✅ 安全变更："},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1936,columnNumber:21},this),d.jsxDEV("p",{className:"text-xs",children:["该",null==(J=Ue.role)?void 0:J.name,"没有待审核的工时记录，可以安全变更生产线。"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1937,columnNumber:21},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1935,columnNumber:19},this),d.jsxDEV("p",{className:"text-blue-300 font-mono text-sm mt-2",children:"生产线变更后将影响用户的工作范围和审批权限。"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1941,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1899,columnNumber:15},this),d.jsxDEV("div",{className:"flex gap-3",children:[d.jsxDEV("button",{onClick:()=>l(this,null,function*(){var e,s,n,t;if(Ue.user&&Ve)try{if(console.log("执行生产线变更数据转移..."),Ue.pendingRecords&&Ue.pendingRecords.length>0){console.log("执行数据转移...");const t="班长"===(null==(e=Ue.role)?void 0:e.name)?"supervisor_id":"section_chief_id",m="班长"===(null==(s=Ue.role)?void 0:s.name)?["pending","待审核","submitted","已提交"]:["approved"],{error:r}=yield M.from("timesheet_records").update({[t]:Ve}).eq(t,Ue.user.id).in("status",m);if(r)throw console.error("数据转移失败:",r),new Error("数据转移失败，请稍后重试");console.log("添加审批历史记录...");const a=null==(n=Ue.sameRoleUsers.find(e=>e.id===Ve))?void 0:n.name;for(const e of Ue.pendingRecords){const{error:s}=yield M.from("approval_history").insert({timesheet_record_id:e.id,approver_id:Se.id,approver_name:Se.name,action:"transfer",comment:`生产线变更：将审核权限从 ${Ue.user.name}(${Ue.oldProductionLine}) 转移给 ${a}(${Ue.oldProductionLine})`,created_at:(new Date).toISOString()});s&&console.error("添加审批历史失败:",s)}console.log(`数据转移成功：${Ue.pendingRecords.length}条记录转移给${a}`)}const{error:m}=yield M.from("users").update({phone:de.phone,id_card:de.id_card,name:de.name,company_id:de.company_id,role_id:de.role_id,production_line:de.production_line||null,is_active:de.is_active,updated_at:(new Date).toISOString()}).eq("id",Ue.user.id);if(m)throw console.error("生产线变更失败:",m),m;if(Ue.pendingRecords&&Ue.pendingRecords.length>0){const e=null==(t=Ue.sameRoleUsers.find(e=>e.id===Ve))?void 0:t.name;R.success(`生产线变更成功！已将${Ue.pendingRecords.length}条待审核数据转移给${e}`)}else R.success("生产线变更成功！");De(!1),Me({user:null,oldProductionLine:"",newProductionLine:"",role:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),Re(""),Ae(),yield Oe()}catch(m){console.error("生产线变更失败:",m),R.error(m.message||"生产线变更失败")}else R.error("请选择数据接收人")}),disabled:(null==(H=Ue.pendingRecords)?void 0:H.length)>0&&!Ve,className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-blue-800 disabled:cursor-not-allowed text-white font-bold rounded transition-colors font-mono",children:[d.jsxDEV(j,{className:"w-4 h-4"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1952,columnNumber:19},this),"确认变更"]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1947,columnNumber:17},this),d.jsxDEV("button",{onClick:()=>{De(!1),Me({user:null,oldProductionLine:"",newProductionLine:"",role:null,pendingRecords:[],sameRoleUsers:[],userNames:[]}),Re(""),Ne(!1)},className:"flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-bold rounded transition-colors font-mono",children:"取消"},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1955,columnNumber:17},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1946,columnNumber:15},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1891,columnNumber:13},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1890,columnNumber:11},this)]},void 0,!0,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1299,columnNumber:7},this)},void 0,!1,{fileName:"/home/runner/work/timesheet-management-system/timesheet-management-system/src/pages/UserManagement.tsx",lineNumber:1298,columnNumber:5},this)}export{$ as default};
